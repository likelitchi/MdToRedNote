<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Visual Clone Pro Suite v27 (Fixed Layout)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=Noto+Serif+TC:wght@300;500;700;900&family=Zen+Maru+Gothic:wght@300;400;500;700;900&family=Permanent+Marker&display=swap');

        :root {
            /* ÈÄô‰∫õÊï∏ÂÄºÁèæÂú®Áî± JS ÁöÑ APP_CONFIG È©ÖÂãï */
            --canvas-w: 1080px;
            --canvas-h: 1350px;
            --header-h: 120px;
            --footer-h: 60px;
            --content-h: 1170px;
            --preview-scale: 0.35;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
            /* ÈóúÈçµ‰øÆÂæ©ÔºöÂº∑Âà∂ÈéñÂÆö Body ÈÅøÂÖç iOS scrollIntoView Â∞éËá¥Êï¥ÂÄãÈ†ÅÈù¢‰ΩçÁßª */
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        /* --- Canvas Layout --- */
        .card-wrapper {
            position: relative;
            margin-bottom: 24px;
            width: calc(var(--canvas-w) * var(--preview-scale));
            height: calc(var(--canvas-h) * var(--preview-scale));
            transition: transform 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            flex-shrink: 0;
            margin-left: auto;
            margin-right: auto;
            scroll-margin-block: 20px;
        }

        .card-container {
            width: var(--canvas-w);
            height: var(--canvas-h);
            background-color: white;
            position: absolute;
            top: 0;
            left: 0;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transform: scale(var(--preview-scale));
            transform-origin: top left;
            cursor: pointer;
            border-radius: 0px;
        }

        .card-wrapper.selected {
            transform: scale(1.02);
            z-index: 10;
        }

        .card-wrapper.selected .card-container {
            box-shadow: 0 0 0 4px #f43f5e, 0 20px 40px rgba(244, 63, 94, 0.2);
        }

        .area-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--header-h);
            z-index: 100;
            pointer-events: none;
        }

        .area-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--footer-h);
            z-index: 100;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .area-content {
            position: absolute;
            top: var(--header-h);
            left: 0;
            width: 100%;
            height: var(--content-h);
            padding: 20px 90px;
            box-sizing: border-box;
            z-index: 10;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* --- Footer Styles --- */
        .footer-pill {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 10px 32px;
            border-radius: 100px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            font-weight: 700;
            color: #475569;
            font-size: 22px;
            letter-spacing: 1px;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .footer-simple {
            color: #94a3b8;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 4px;
            font-family: 'Noto Sans TC', sans-serif;
        }

        /* --- Markdown Styles --- */
        .md-content h1 {
            font-size: 64px;
            font-weight: 900;
            line-height: 1.2;
            margin-bottom: 24px;
            white-space: pre-wrap;
        }

        .md-content h2 {
            font-size: 56px;
            font-weight: 800;
            line-height: 1.2;
            margin-bottom: 20px;
            margin-top: 10px;
            white-space: pre-wrap;
        }

        .md-content h3 {
            font-size: 48px;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 16px;
            white-space: pre-wrap;
        }

        .md-content p {
            font-size: 36px;
            line-height: 1.6;
            margin-bottom: 24px;
            white-space: pre-wrap;
        }

        .md-content ul {
            list-style-type: disc;
            padding-left: 1.2em;
            margin-bottom: 24px;
        }

        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.2em;
            margin-bottom: 24px;
        }

        .md-content li {
            font-size: 36px;
            line-height: 1.6;
            margin-bottom: 12px;
            white-space: pre-wrap;
        }

        .md-content blockquote {
            border-left: 8px solid #cbd5e1;
            padding-left: 24px;
            font-style: italic;
            opacity: 0.8;
            margin-bottom: 24px;
            white-space: pre-wrap;
        }

        .md-content strong {
            font-weight: 900;
            color: inherit;
        }

        .md-content code {
            background: rgba(0, 0, 0, 0.08);
            padding: 4px 8px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
        }

        /* --- Styles Definition (24) --- */
        .style-minimal {
            font-family: 'Noto Sans TC';
            background: #fff;
            color: #1e293b;
        }

        .style-minimal .min-line {
            width: 60px;
            height: 6px;
            background: var(--theme);
            margin: 40px 0;
            border-radius: 10px;
        }

        .style-poster {
            font-family: 'Noto Sans TC';
            background: var(--theme);
            color: #fff;
        }

        .style-poster .poster-box {
            background: #1e293b;
            color: #fff !important;
            padding: 40px 50px;
            width: 100%;
            box-shadow: 20px 20px 0px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }

        .style-poster .poster-box h1,
        .style-poster .poster-box h2 {
            color: var(--theme) !important;
        }

        .style-memo {
            font-family: 'Noto Sans TC';
            background: #fffbeb;
            color: #4b5563;
            background-image: linear-gradient(#e5e7eb 1px, transparent 1px), linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
            background-size: 40px 40px;
        }

        .style-memo .sticky-note {
            background: #fef3c7;
            padding: 40px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: rotate(-1deg);
            border-radius: 2px;
            color: #451a03;
            margin-bottom: 30px;
        }

        .style-journal {
            font-family: 'Zen Maru Gothic';
            background: #fff1f2;
            color: #881337;
        }

        .style-journal .journal-card {
            background: rgba(255, 255, 255, 0.8);
            border: 2px dashed var(--theme);
            border-radius: 40px;
            padding: 40px;
            margin-bottom: 24px;
        }

        .style-glass {
            font-family: 'Noto Sans TC';
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            color: #1e293b;
        }

        .style-glass .glass-panel {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(40px);
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.6);
            padding: 40px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
            margin-bottom: 24px;
        }

        .style-cyber {
            font-family: 'Noto Sans TC';
            background: #fff;
            color: #334155;
            overflow: hidden;
        }

        .style-cyber::before {
            content: "";
            position: absolute;
            top: -20%;
            right: -20%;
            width: 800px;
            height: 800px;
            background: radial-gradient(circle, var(--theme) 0%, transparent 70%);
            opacity: 0.3;
            z-index: 0;
        }

        .style-cyber .aura-box {
            position: relative;
            z-index: 10;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.8);
            margin-bottom: 24px;
            border-left: 4px solid var(--theme);
        }

        .style-luxury {
            font-family: 'Noto Serif TC';
            background: #f8fafc;
            color: #1e293b;
        }

        .style-luxury .mag-line {
            width: 100%;
            height: 1px;
            background: var(--theme);
            margin: 30px 0;
        }

        .style-luxury h1,
        .style-luxury h2 {
            font-style: italic;
        }

        .style-pop {
            font-family: 'Noto Sans TC';
            background: #ffedd5;
            color: #1e293b;
        }

        .style-pop .pop-card {
            background: #fff;
            border: 3px solid #000;
            box-shadow: 12px 12px 0 var(--theme);
            padding: 40px;
            border-radius: 16px;
            margin-bottom: 30px;
        }

        .style-dry {
            font-family: 'Noto Sans TC';
            background: #f1f5f9;
            color: #334155;
        }

        .style-dry .floating-card {
            background: #fff;
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
        }

        .style-paper {
            font-family: 'Noto Serif TC';
            background: #fdf6e3;
            color: #433422;
        }

        .style-paper .paper-sheet {
            background: #fff;
            padding: 50px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-radius: 2px;
            margin-bottom: 24px;
        }

        .style-solid {
            font-family: 'Noto Sans TC';
            background: var(--theme);
            color: white;
        }

        .style-solid .solid-content {
            border-left: 6px solid rgba(255, 255, 255, 0.4);
            padding-left: 40px;
            margin-bottom: 30px;
        }

        .style-brutal {
            font-family: 'Noto Sans TC';
            background: #fff;
            color: #000;
        }

        .style-brutal .outline-box {
            border: 3px solid var(--theme);
            padding: 30px;
            border-radius: 24px;
            background: #fff;
            margin-bottom: 24px;
        }

        .style-retro {
            font-family: 'Noto Serif TC';
            background: #e2e8f0;
            color: #1e293b;
        }

        .style-retro .film-frame {
            background: #fff;
            padding: 60px 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            border: 1px solid var(--theme);
        }

        .style-dark {
            font-family: 'Noto Sans TC';
            background: #0f172a;
            color: #e2e8f0;
        }

        .style-dark .dark-card {
            background: #1e293b;
            border-radius: 20px;
            padding: 40px;
            border: 1px solid var(--theme);
            margin-bottom: 24px;
        }

        .style-comic {
            font-family: 'Zen Maru Gothic';
            background: #fff;
            color: #333;
            background-image: radial-gradient(var(--theme) 2px, transparent 2px);
            background-size: 20px 20px;
        }

        .style-comic .doodle-box {
            border: 3px solid #333;
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            padding: 40px;
            background: #fff;
            margin-bottom: 30px;
        }

        .style-elegant {
            font-family: 'Noto Sans TC';
            background: #fafafa;
            color: #525252;
        }

        .style-elegant .air-box {
            padding: 30px 0;
            border-left: 2px solid var(--theme);
            padding-left: 40px;
            margin-bottom: 20px;
        }

        .style-playful {
            font-family: 'Zen Maru Gothic';
            background: #fff7ed;
            color: #7c2d12;
        }

        .style-playful .soft-blob {
            background: #ffedd5;
            border-radius: 30px;
            padding: 40px;
            margin-bottom: 24px;
        }

        .style-tech {
            font-family: 'Noto Sans TC';
            background: #f8fafc;
            color: #334155;
        }

        .style-tech .tech-card {
            border-left: 6px solid var(--theme);
            background: white;
            padding: 40px;
            border-radius: 0 16px 16px 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            margin-bottom: 24px;
        }

        .style-ink {
            font-family: 'Noto Serif TC';
            background: #f5f5f4;
            color: #44403c;
        }

        .style-ink .zen-circle {
            border: 1px solid var(--theme);
            border-radius: 50%;
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 40px;
            color: var(--theme);
        }

        .style-ink .ink-content {
            border-left: 4px solid var(--theme);
            padding-left: 30px;
            margin-bottom: 30px;
        }

        .style-boxy {
            font-family: 'Noto Sans TC';
            background: #f1f5f9;
            color: #334155;
        }

        .style-boxy .grid-unit {
            background: #fff;
            padding: 36px;
            margin-bottom: 20px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            border-left: 5px solid var(--theme);
        }

        .style-frame {
            font-family: 'Noto Serif TC';
            background: #f8fafc;
            color: #334155;
        }

        .style-frame .frame-border {
            border: 4px double var(--theme);
            height: 100%;
            padding: 50px 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: #fff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }

        .style-neon {
            font-family: 'Noto Sans TC';
            background: #111;
            color: #fff;
        }

        .style-neon .neon-border {
            border: 4px solid var(--theme);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 0 20px var(--theme), inset 0 0 20px var(--theme);
            text-shadow: 0 0 10px var(--theme);
        }

        .style-blob {
            font-family: 'Noto Sans TC';
            background: #fff;
            color: #1e293b;
            overflow: hidden;
        }

        .style-blob .blob-shape {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 900px;
            height: 900px;
            background: linear-gradient(45deg, var(--theme), #e0c3fc);
            border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
            opacity: 0.2;
            z-index: 0;
            filter: blur(40px);
        }

        .style-blob .blob-content {
            position: relative;
            z-index: 10;
        }

        .style-cutout {
            font-family: 'Noto Sans TC';
            background: var(--theme);
            color: #fff;
        }

        .style-cutout .cutout-text {
            color: #fff;
            mix-blend-mode: overlay;
            font-weight: 900;
        }

        .style-checklist {
            font-family: 'Noto Sans TC';
            background: #f0f9ff;
            color: #334155;
        }

        .style-checklist .check-item {
            background: #fff;
            padding: 24px 30px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .style-checklist .check-box {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #dbeafe;
            color: var(--theme);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        /* IP Layer */
        .ip-layer {
            position: absolute;
            inset: 0;
            z-index: 200;
            pointer-events: none;
        }

        .draggable-ip {
            position: absolute;
            width: 250px;
            height: auto;
            cursor: grab;
            pointer-events: auto;
            touch-action: none;
            user-select: none;
            will-change: transform;
            filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.15));
            top: 0;
            left: 0;
        }

        .draggable-ip:active {
            cursor: grabbing;
        }

        .draggable-ip.active-icon {
            outline: 4px solid #3b82f6;
            border-radius: 4px;
        }

        .draggable-ip:hover {
            border: 2px dashed rgba(244, 63, 94, 0.5);
        }

        /* Cover Image */
        .cover-pop {
            position: absolute;
            bottom: -40px;
            right: -40px;
            width: 65%;
            transform: rotate(-3deg);
            filter: drop-shadow(0 25px 25px rgba(0, 0, 0, 0.25));
            pointer-events: none;
            z-index: 20;
        }

        .swipe-hint {
            position: absolute;
            bottom: 40px;
            right: 40px;
            font-weight: 900;
            font-size: 24px;
            color: rgba(0, 0, 0, 0.3);
            animation: bounce 2s infinite;
            pointer-events: none;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateX(0);
            }

            50% {
                transform: translateX(10px);
            }
        }

        #export-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.95);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .nav-btn.active {
            background-color: rgb(241, 245, 249);
            color: rgb(15, 23, 42);
        }

        .nav-btn {
            color: rgb(100, 116, 139);
        }

        .char-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .char-item {
            aspect-ratio: 1;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            transition: all 0.2s;
        }

        .char-item:hover {
            border-color: #f43f5e;
            background-color: #fff1f2;
            transform: translateY(-2px);
        }

        .char-item img {
            width: 70%;
            height: 70%;
            object-fit: contain;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            #preview-section {
                flex: 0 0 38% !important;
                min-height: 0;
            }
        }

        /* Nav controls */
        .merger-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            z-index: 50;
            color: #475569;
            transition: all 0.2s;
        }

        .merger-nav-btn:hover {
            background: white;
            color: #0f172a;
            transform: translateY(-50%) scale(1.1);
        }

        .merger-nav-btn.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        .sticker-tab.active {
            background-color: #fecdd3;
            color: #be123c;
            border-color: #fda4af;
        }
    </style>
</head>

<body class="bg-slate-50">

    <header
        class="shrink-0 h-14 bg-white border-b border-slate-200 flex items-center justify-between px-4 md:px-6 z-50">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
                <div
                    class="w-8 h-8 bg-rose-500 rounded-lg flex items-center justify-center text-white shadow-sm shadow-rose-200">
                    <i data-lucide="layers" size="18"></i>
                </div>
                <h1 class="text-lg font-bold tracking-tight text-slate-800 hidden md:block">Visual <span
                        class="text-rose-500">Suite v27</span></h1>
            </div>

            <div class="flex bg-slate-100 p-1 rounded-lg">
                <button onclick="switchMode('gen')" id="nav-gen"
                    class="nav-btn active px-3 py-1.5 rounded-md text-xs font-bold transition-all flex items-center gap-2">
                    <i data-lucide="pen-tool" size="14"></i> <span class="hidden md:inline">Âç°Áâá</span>
                </button>
                <button onclick="switchMode('merge')" id="nav-merge"
                    class="nav-btn px-3 py-1.5 rounded-md text-xs font-bold transition-all flex items-center gap-2">
                    <i data-lucide="scissors" size="14"></i> <span class="hidden md:inline">ÊãºÊé•</span>
                </button>
            </div>
        </div>

        <div class="flex items-center gap-2">
            <button onclick="document.getElementById('import-json').click()"
                class="text-slate-500 hover:text-slate-800 p-2 rounded-full hover:bg-slate-100 transition-all"
                title="ÂåØÂÖ•Â∞àÊ°à">
                <i data-lucide="upload" size="18"></i>
            </button>
            <input type="file" id="import-json" class="hidden" accept=".json" onchange="importJSON(event)">

            <button onclick="exportJSON()"
                class="text-slate-500 hover:text-slate-800 p-2 rounded-full hover:bg-slate-100 transition-all"
                title="ÂÇô‰ªΩÂ∞àÊ°à">
                <i data-lucide="save" size="18"></i>
            </button>

            <button onclick="resetProject()"
                class="text-red-400 hover:text-red-600 p-2 rounded-full hover:bg-red-50 transition-all" title="ÈáçÁΩÆ">
                <i data-lucide="trash-2" size="18"></i>
            </button>

            <button onclick="handleExport()" id="export-btn"
                class="bg-rose-500 hover:bg-rose-600 text-white px-4 md:px-6 py-1.5 rounded-full font-bold flex items-center gap-2 transition-all shadow-lg shadow-rose-200 active:scale-95 text-xs md:text-sm ml-2">
                <i data-lucide="download" size="14"></i> <span id="dl-text">‰∏ãËºâ</span>
            </button>
        </div>
    </header>

    <main class="flex-1 flex flex-col md:flex-row overflow-hidden h-full min-h-0">

        <!-- Preview Section -->
        <section id="preview-section"
            class="order-1 md:order-2 shrink-0 h-[38%] md:h-full md:flex-1 bg-slate-100 overflow-hidden flex flex-col relative border-b md:border-b-0 shadow-inner"
            style="flex: 0 0 38%; md:flex:1 1 0%;">
            <div
                class="mb-4 flex items-center gap-4 text-slate-400 bg-white px-4 py-1.5 rounded-full shadow-sm sticky top-4 z-30 opacity-80 md:opacity-100 scale-90 md:scale-100 origin-top mx-auto">
                <i data-lucide="mouse-pointer-2" size="14"></i>
                <span class="text-xs font-bold uppercase tracking-tighter" id="preview-title">È†êË¶ΩÂçÄ</span>
            </div>

            <div id="canvas-wrapper"
                class="flex-1 w-full overflow-y-auto custom-scroll p-4 pb-12 flex flex-col items-center min-h-0"></div>

            <div id="merger-wrapper" class="hidden flex-1 w-full h-full relative">
                <div id="merge-prev" class="merger-nav-btn left-4 hidden" onclick="changeMergeSlide(-1)"><i
                        data-lucide="chevron-left" size="24"></i></div>
                <div id="merge-next" class="merger-nav-btn right-4 hidden" onclick="changeMergeSlide(1)"><i
                        data-lucide="chevron-right" size="24"></i></div>

                <div class="w-full h-full overflow-y-auto custom-scroll p-4 pb-12 flex flex-col items-center min-h-0">
                    <div class="card-wrapper" style="margin-top: 0;">
                        <div id="merger-card" class="card-container">
                            <div id="merge-bg-el" class="absolute inset-0 w-full h-full hidden"
                                style="background-size: cover; background-position: center;"></div>
                            <div class="area-header"></div>
                            <div class="absolute top-[120px] bottom-[60px] left-0 w-full overflow-hidden z-10">
                                <img id="merge-overlay-el" class="w-full h-auto hidden" />
                            </div>
                            <div class="area-footer"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sidebar -->
        <aside
            class="order-2 md:order-1 flex-1 md:flex-none md:w-[420px] bg-white border-r border-slate-200 flex flex-col overflow-hidden z-20 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] md:shadow-none min-h-0">
            <div class="flex-1 overflow-y-auto p-5 pb-[150px] md:pb-6 custom-scroll min-h-0"
                style="padding-bottom: max(150px, env(safe-area-inset-bottom));">

                <div id="sidebar-gen" class="space-y-6 pb-8">
                    <section class="space-y-3">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">1. È¢®Ê†ºÈÅ∏Êìá</h3>
                        <div class="grid grid-cols-4 gap-2" id="style-selector"></div>
                    </section>
                    <section class="space-y-3">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">2. Á¥†ÊùêË®≠ÂÆö</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <label
                                class="border border-slate-200 rounded-lg p-3 flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50 transition-all bg-white h-20">
                                <i data-lucide="image" class="text-slate-400 mb-1" size="16"></i>
                                <span class="text-[10px] font-bold text-slate-600">ËÉåÊôØÂúñ</span>
                                <input type="file" class="hidden" accept="image/*"
                                    onchange="handleImgUpload(event, 'base')">
                            </label>

                            <label
                                class="border border-slate-200 rounded-lg p-3 flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50 transition-all bg-white h-20 relative overflow-hidden group">
                                <i data-lucide="star" class="text-rose-400 mb-1" size="16"></i>
                                <span class="text-[10px] font-bold text-slate-600">Â∞ÅÈù¢‰∏ªËßí</span>
                                <div
                                    class="absolute inset-0 bg-rose-50 opacity-0 group-hover:opacity-10 transition-opacity">
                                </div>
                                <input type="file" class="hidden" accept="image/*"
                                    onchange="handleImgUpload(event, 'cover')">
                            </label>
                        </div>
                        <div class="flex items-center gap-2 px-1">
                            <input type="checkbox" id="check-default-bg"
                                class="w-4 h-4 rounded text-rose-600 focus:ring-rose-500">
                            <label for="check-default-bg" class="text-xs text-slate-500 font-bold">‰ΩøÁî®ÈªòË™çËÉåÊôØ
                                (frame.png)</label>
                        </div>

                        <div class="flex items-center gap-2 p-1 bg-slate-50 rounded-lg mb-2 mt-2">
                            <button id="tab-princess"
                                class="sticker-tab flex-1 py-1.5 text-xs font-bold rounded-md border border-transparent transition-all text-slate-500"
                                onclick="switchStickerTab('princess')">ÂÖ¨‰∏ª</button>
                            <button id="tab-doctor"
                                class="sticker-tab flex-1 py-1.5 text-xs font-bold rounded-md border border-transparent transition-all text-slate-500"
                                onclick="switchStickerTab('doctor')">ÂçöÂ£´</button>
                        </div>
                        <div class="char-grid" id="default-chars"></div>

                        <div class="pt-2 border-t border-slate-100 mt-2">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Ë≤ºÁ¥ôË®≠ÂÆö</span>
                                <span id="icon-scale-val" class="text-[10px] font-mono text-slate-400">1.0x</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="range" id="icon-scale-slider" min="0.5" max="3.0" step="0.1" value="1.0"
                                    class="w-full accent-rose-500 h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer flex-1"
                                    oninput="updateIconScale(this.value)">
                                <button onclick="toggleIconFlip()"
                                    class="p-1.5 rounded-md border border-slate-200 hover:bg-slate-50 text-slate-500 transition-colors"
                                    title="Â∑¶Âè≥ÁøªËΩâ">
                                    <i data-lucide="flip-horizontal" size="16"></i>
                                </button>
                            </div>
                        </div>
                    </section>
                    <section class="space-y-3">
                        <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest">3. ÂÖßÂÆπÊñáÊ°à</h3>
                        <input type="text" id="in-title"
                            class="w-full border border-slate-200 rounded-lg p-3 font-bold focus:ring-2 focus:ring-rose-500 outline-none text-slate-700 text-sm"
                            placeholder="Â∞ÅÈù¢Ê®ôÈ°å">

                        <div class="flex items-center gap-2">
                            <div class="flex items-center h-full pt-1" title="È°ØÁ§∫/Èö±Ëóè ÁΩ≤Âêç">
                                <input type="checkbox" id="check-show-author"
                                    class="w-5 h-5 rounded text-rose-600 focus:ring-rose-500 cursor-pointer border-slate-300">
                            </div>
                            <input type="text" id="in-author"
                                class="flex-1 border border-slate-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-rose-500 outline-none text-slate-600"
                                placeholder="ÁΩ≤Âêç / IG">
                        </div>

                        <textarea id="in-content" rows="6"
                            class="w-full border border-slate-200 rounded-lg p-3 text-sm leading-relaxed focus:ring-2 focus:ring-rose-500 outline-none resize-none text-slate-600"
                            placeholder="Ê≠£ÊñáÂÖßÂÆπ (Ëº∏ÂÖ• '---' Âº∑Âà∂ÂàÜÈ†Å)"></textarea>

                        <!-- Footer Settings -->
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 space-y-2">
                            <span class="text-xs font-bold text-slate-500">È†ÅÂ∞æÊ®°Âºè</span>
                            <div class="flex items-center gap-3">
                                <label class="flex items-center gap-1"><input type="radio" name="footer-mode"
                                        value="pagenum" class="text-rose-600"><span class="text-xs">È†ÅÁ¢º</span></label>
                                <label class="flex items-center gap-1"><input type="radio" name="footer-mode"
                                        value="text" class="text-rose-600"><span class="text-xs">ÊñáÂ≠ó</span></label>
                                <label class="flex items-center gap-1"><input type="radio" name="footer-mode"
                                        value="none" class="text-rose-600"><span class="text-xs">ÁÑ°</span></label>
                            </div>
                            <input type="text" id="in-ad"
                                class="w-full border border-slate-200 rounded p-2 text-xs hidden"
                                placeholder="Ëº∏ÂÖ•Êé®Âª£Ë™û...">
                        </div>
                    </section>
                    <section class="space-y-3">
                        <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest">4. ‰∏ªÈ°åËâ≤</h3>
                        <div id="theme-box" class="flex gap-3 overflow-x-auto pb-2"></div>
                    </section>
                </div>

                <div id="sidebar-merge" class="space-y-6 hidden pb-8">
                    <section class="space-y-4">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Èï∑ÂúñÊãºÊé• (Batch Merger)</h3>
                        <div class="flex items-center gap-2 mb-2">
                            <input type="checkbox" id="check-merger-default-bg" class="w-4 h-4 rounded text-rose-600">
                            <label for="check-merger-default-bg" class="text-xs font-bold text-slate-600">‰ΩøÁî®ÈªòË™çËÉåÊôØ</label>
                        </div>
                        <label
                            class="block border-2 border-dashed border-slate-200 rounded-xl p-4 text-center cursor-pointer hover:bg-blue-50">
                            <span class="text-xs font-bold block text-slate-500">‰∏äÂÇ≥ËÉåÊôØ (Base)</span>
                            <input type="file" class="hidden" onchange="handleMergerUpload(event, 'bg')">
                        </label>

                        <label
                            class="block border-2 border-dashed border-slate-200 rounded-xl p-4 text-center cursor-pointer hover:bg-blue-50 relative group">
                            <div
                                class="absolute inset-0 bg-blue-100 opacity-0 group-hover:opacity-20 transition-opacity rounded-xl">
                            </div>
                            <i data-lucide="files" class="mx-auto mb-2 text-blue-400"></i>
                            <span class="text-xs font-bold block text-slate-600">ÊâπÈáè‰∏äÂÇ≥Èï∑Âúñ (Overlays)</span>
                            <span class="text-[10px] text-slate-400 block mt-1">ÊîØÊè¥Â§öÈÅ∏Ôºå‰∏ÄÊ¨°ÁîüÊàê</span>
                            <input type="file" class="hidden" multiple onchange="handleMergerUpload(event, 'overlay')">
                        </label>

                        <div class="bg-blue-50 p-4 rounded-lg text-xs text-blue-800 leading-relaxed">
                            <p>üí° <b>ÊèêÁ§∫Ôºö</b></p>
                            <ul class="list-disc pl-4 mt-1 space-y-1">
                                <li>ÂèØ‰∏ÄÊ¨°ÈÅ∏ÂèñÂ§öÂºµÈï∑Êà™Âúñ„ÄÇ</li>
                                <li>ÊâÄÊúâÂúñÁâáÂ∞áÂ•óÁî®Âêå‰∏ÄÂºµËÉåÊôØÂúñ„ÄÇ</li>
                                <li>ÈªûÊìä„Äå‰∏ãËºâ„ÄçÂ∞áËá™ÂãïÊâìÂåÖÊâÄÊúâÊãºÊé•ÁµêÊûúÁÇ∫ ZIP„ÄÇ</li>
                            </ul>
                        </div>
                    </section>

                    <!-- NEW: Merger Footer Settings -->
                    <section class="space-y-3">
                        <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest">È†ÅÂ∞æË®≠ÂÆö</h3>
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 space-y-2">
                            <span class="text-xs font-bold text-slate-500">È†ÅÂ∞æÊ®°Âºè</span>
                            <div class="flex items-center gap-3">
                                <label class="flex items-center gap-1"><input type="radio" name="merge-footer-mode"
                                        value="pagenum" class="text-rose-600"><span class="text-xs">È†ÅÁ¢º</span></label>
                                <label class="flex items-center gap-1"><input type="radio" name="merge-footer-mode"
                                        value="text" class="text-rose-600"><span class="text-xs">ÊñáÂ≠ó</span></label>
                                <label class="flex items-center gap-1"><input type="radio" name="merge-footer-mode"
                                        value="none" class="text-rose-600"><span class="text-xs">ÁÑ°</span></label>
                            </div>
                            <input type="text" id="merge-in-ad"
                                class="w-full border border-slate-200 rounded p-2 text-xs hidden"
                                placeholder="Ëº∏ÂÖ•Êé®Âª£Ë™û...">
                        </div>
                    </section>
                </div>

            </div>
        </aside>
    </main>

    <div id="export-overlay">
        <div class="animate-spin text-rose-400 mb-6"><i data-lucide="refresh-cw" size="64"></i></div>
        <h2 class="text-2xl font-black mb-2 tracking-tighter uppercase text-center">ËôïÁêÜ‰∏≠...</h2>
        <p class="text-slate-400 font-mono" id="progress-val">Initializing...</p>
    </div>

    <div id="measurer" class="md-content"
        style="position:absolute; visibility:hidden; width:900px; font-size:36px; line-height:1.6;"></div>

    <script>
        // --- APP CONFIGURATION ---
        const APP_CONFIG = {
            width: 1080,
            height: 1350,
            headerHeight: 120,
            footerHeight: 60,
            contentPadding: 60,
            bgUrl: 'frame.png'
        };

        const root = document.documentElement;
        root.style.setProperty('--canvas-w', APP_CONFIG.width + 'px');
        root.style.setProperty('--canvas-h', APP_CONFIG.height + 'px');
        root.style.setProperty('--header-h', APP_CONFIG.headerHeight + 'px');
        root.style.setProperty('--footer-h', APP_CONFIG.footerHeight + 'px');
        const contentH = APP_CONFIG.height - APP_CONFIG.headerHeight - APP_CONFIG.footerHeight - 20;
        root.style.setProperty('--content-h', contentH + 'px');

        // New Sticker Sets
        const STICKER_DATA = {
            princess: [
                "character/princess/princess-1.png", "character/princess/princess-2.png", "character/princess/princess-3.png", "character/princess/princess-4.png",
                "character/princess/princess-5.png", "character/princess/princess-6.png", "character/princess/princess-7.png", "character/princess/princess-8.png",
                "character/princess/princess-9.png", "character/princess/princess-10.png", "character/princess/princess-11.png", "character/princess/princess-12.png",
                "character/princess/princess-13.png"
            ],
            doctor: [
                "character/doctor/doctor-1.png", "character/doctor/doctor-2.png", "character/doctor/doctor-3.png", "character/doctor/doctor-4.png",
                "character/doctor/doctor-5.png", "character/doctor/doctor-6.png", "character/doctor/doctor-7.png", "character/doctor/doctor-8.png",
                "character/doctor/doctor-9.png", "character/doctor/doctor-10.png", "character/doctor/doctor-11.png", "character/doctor/doctor-12.png"
            ]
        };

        const styleConfigs = [
            { id: 'minimal', name: 'Ê•µÁ∞°', icon: 'monitor' },
            { id: 'poster', name: 'ÁÑ¶Èªû', icon: 'megaphone' },
            { id: 'memo', name: 'Á≠ÜË®ò', icon: 'file-text' },
            { id: 'journal', name: 'ÊâãË≥¨', icon: 'scissors' },
            { id: 'glass', name: 'ÁéªÁíÉ', icon: 'droplet' },
            { id: 'cyber', name: 'ÂÖâÊÑü', icon: 'sun' },
            { id: 'luxury', name: 'ÈõúË™å', icon: 'book' },
            { id: 'pop', name: 'ÊíûËâ≤', icon: 'zap' },
            { id: 'dry', name: 'Âç°Áâá', icon: 'credit-card' },
            { id: 'paper', name: 'Á¥ôË≥™', icon: 'newspaper' },
            { id: 'neon', name: 'ÈúìËôπ', icon: 'zap-off' },
            { id: 'blob', name: 'ÊµÅÈ´î', icon: 'cloud' },
            { id: 'cutout', name: 'Èè§Á©∫', icon: 'scissors' },
            { id: 'checklist', name: 'Ê∏ÖÂñÆ', icon: 'check-square' },
            { id: 'brutal', name: 'Á∑öÊ°Ü', icon: 'box' },
            { id: 'retro', name: 'ËÜ†Áâá', icon: 'camera' },
            { id: 'dark', name: 'Â§úÈñì', icon: 'moon' },
            { id: 'comic', name: 'Â°óÈ¥â', icon: 'smile' },
            { id: 'elegant', name: 'Á¥îÊ∑®', icon: 'feather' },
            { id: 'playful', name: 'ÊüîÂíå', icon: 'heart' },
            { id: 'tech', name: 'Áèæ‰ª£', icon: 'cpu' },
            { id: 'ink', name: 'Á¶™ÊÑè', icon: 'pen-tool' },
            { id: 'boxy', name: 'ÊñπÂ°ä', icon: 'grid' },
            { id: 'frame', name: 'Â§ñÊ°Ü', icon: 'square' }
        ];

        const themes = ["#f43f5e", "#3b82f6", "#10b981", "#f59e0b", "#000000"];

        // --- Core State ---
        let state = {
            mode: 'gen',
            title: "2024Âπ¥ÂøÖÈ†àÊéåÊè°ÁöÑ\nÂâçÁ´ØË¶ñË¶∫ÈñãÁôºÊäÄÂ∑ß",
            author: "@VisualCloneLab",
            content: `## 1. ÊéåÊè°Ëâ≤ÂΩ©ÂøÉÁêÜÂ≠∏\nËâ≤ÂΩ©‰∏çÂÉÖÊòØË£ùÈ£æ„ÄÇ\n\n---\n\n## 2. ÁïôÁôΩÁöÑËóùË°ì\n> ÁïôÁôΩ‰∏çÊòØÁ©∫ÔºåËÄåÊòØË®≠Ë®àÁöÑÂëºÂê∏„ÄÇ\n\n‰∏çË¶ÅÂ°´ÊªøÊØè‰∏ÄÂÄãËßíËêΩ„ÄÇ`,
            footerMode: 'pagenum',
            adText: "ÈªûËÆö + Êî∂Ëóè ‚ú®",
            theme: "#f43f5e",
            style: "minimal",
            useDefaultBg: true,
            uploadedBaseImg: null,
            coverImg: null,
            selectedCardIndex: 0,
            cardIcons: {},
            useDefaultBgMerger: true,
            mergeBg: null,
            mergeOverlays: [],
            currentMergeIndex: 0,
            previewScale: 0.35,
            showAuthor: false, // Default untick
            stickerTab: 'princess',
            activeIcon: null
        };

        const saved = localStorage.getItem("visual_clone_project");
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed };
                state.activeIcon = null;
            } catch (e) { console.error("Load failed", e); }
        }

        let dragTarget = null;
        let initialX, initialY, startX, startY;
        let renderQueued = false;

        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        const persistState = debounce(() => {
            localStorage.setItem("visual_clone_project", JSON.stringify(state));
        }, 1000);

        function updateState(key, value) {
            state[key] = value;
            persistState();
        }

        function scheduleRender(options) {
            if (renderQueued) return;
            renderQueued = true;
            requestAnimationFrame(() => {
                renderGen(options);
                renderQueued = false;
            });
        }

        function renderThemeButtons() {
            const tBox = document.getElementById('theme-box');
            tBox.innerHTML = '';
            themes.forEach(c => {
                const b = document.createElement('button');
                b.className = `w-8 h-8 rounded-full border-2 border-white shadow-sm shrink-0 transition-transform active:scale-90 ${state.theme === c ? 'ring-2 ring-slate-400' : ''}`;
                b.style.backgroundColor = c;
                b.onclick = () => {
                    updateState('theme', c);
                    renderThemeButtons();
                    scheduleRender({ scroll: false });
                };
                tBox.appendChild(b);
            });
        }

        function init() {
            lucide.createIcons();

            const sBox = document.getElementById('style-selector');
            styleConfigs.forEach(s => {
                const btn = document.createElement('button');
                btn.id = `btn-${s.id}`;
                btn.className = `p-2 border rounded-lg flex flex-col items-center gap-1 transition-all ${state.style === s.id ? 'border-rose-500 bg-rose-50 ring-1 ring-rose-200' : 'border-slate-200 hover:bg-slate-50'}`;
                btn.innerHTML = `<i data-lucide="${s.icon}" size="14" class="${state.style === s.id ? 'text-rose-500' : 'text-slate-400'}"></i><span class="text-[10px] font-bold whitespace-nowrap text-slate-600">${s.name}</span>`;
                btn.onclick = () => switchStyle(s.id);
                sBox.appendChild(btn);
            });

            renderThemeButtons();
            switchStickerTab(state.stickerTab || 'princess');

            bindInput('in-title', 'title');
            bindInput('in-author', 'author');
            bindInput('in-content', 'content');
            bindInput('in-ad', 'adText');
            bindInput('merge-in-ad', 'adText');

            const authCheck = document.getElementById('check-show-author');
            authCheck.checked = state.showAuthor;
            authCheck.onchange = (e) => {
                updateState('showAuthor', e.target.checked);
                scheduleRender({ scroll: false });
            };

            const adInput = document.getElementById('in-ad');
            document.querySelector(`input[name="footer-mode"][value="${state.footerMode}"]`).checked = true;
            if (state.footerMode === 'text') adInput.classList.remove('hidden');

            document.getElementsByName('footer-mode').forEach(r => {
                r.addEventListener('change', (e) => {
                    updateState('footerMode', e.target.value);
                    if (state.footerMode === 'text') {
                        adInput.classList.remove('hidden');
                        adInput.value = state.adText;
                    } else {
                        adInput.classList.add('hidden');
                    }
                    scheduleRender({ scroll: false });
                });
            });

            const mergeAdInput = document.getElementById('merge-in-ad');
            document.querySelector(`input[name="merge-footer-mode"][value="${state.footerMode}"]`).checked = true;
            if (state.footerMode === 'text') mergeAdInput.classList.remove('hidden');

            document.getElementsByName('merge-footer-mode').forEach(r => {
                r.addEventListener('change', (e) => {
                    updateState('footerMode', e.target.value);
                    if (state.footerMode === 'text') {
                        mergeAdInput.classList.remove('hidden');
                        mergeAdInput.value = state.adText;
                    } else {
                        mergeAdInput.classList.add('hidden');
                    }
                    renderMerger();
                });
            });

            const defBg = document.getElementById('check-default-bg');
            defBg.checked = state.useDefaultBg;
            defBg.onchange = (e) => { updateState('useDefaultBg', e.target.checked); scheduleRender({ scroll: false }); };

            const mergDefBg = document.getElementById('check-merger-default-bg');
            mergDefBg.checked = state.useDefaultBgMerger;
            mergDefBg.onchange = (e) => { updateState('useDefaultBgMerger', e.target.checked); renderMerger(); };

            window.addEventListener('pointermove', onGlobalPointerMove);
            window.addEventListener('pointerup', onGlobalPointerUp);
            window.addEventListener('resize', () => { adjustScale(); scheduleRender({ scroll: false }); });

            adjustScale();
            renderGen({ scroll: false });
        }

        function updateIconScale(val) {
            if (state.activeIcon) {
                const { cardIdx, iconIdx } = state.activeIcon;
                if (state.cardIcons[cardIdx] && state.cardIcons[cardIdx][iconIdx]) {
                    state.cardIcons[cardIdx][iconIdx].scale = parseFloat(val);
                    document.getElementById('icon-scale-val').innerText = parseFloat(val).toFixed(1) + 'x';
                    persistState();
                    scheduleRender({ scroll: false });
                }
            }
        }

        function switchStickerTab(tab) {
            updateState('stickerTab', tab);
            document.querySelectorAll('.sticker-tab').forEach(btn => {
                btn.classList.remove('active', 'bg-rose-100', 'text-rose-600', 'border-rose-200');
                btn.classList.add('text-slate-500', 'border-transparent');
            });
            const activeBtn = document.getElementById(`tab-${tab}`);
            if (activeBtn) {
                activeBtn.classList.add('active', 'bg-rose-100', 'text-rose-600', 'border-rose-200');
                activeBtn.classList.remove('text-slate-500', 'border-transparent');
            }
            const cGrid = document.getElementById('default-chars');
            cGrid.innerHTML = '';
            const stickers = STICKER_DATA[tab] || STICKER_DATA['princess'];
            stickers.forEach(src => {
                const div = document.createElement('div');
                div.className = 'char-item';
                div.innerHTML = `<img src="${src}">`;
                div.onclick = () => addIconToSelectedCard(src);
                cGrid.appendChild(div);
            });
        }

        const debouncedUpdateContent = debounce((key, value) => {
            state[key] = value;
            persistState();
            scheduleRender({ scroll: false });
        }, 150);

        function bindInput(id, key) {
            const el = document.getElementById(id);
            if (el) {
                el.value = state[key];
                el.oninput = (e) => {
                    if (key === 'content') {
                        debouncedUpdateContent(key, e.target.value);
                    } else {
                        state[key] = e.target.value;
                        persistState();
                        if (state.mode === 'merge' && key === 'adText') renderMerger();
                        else scheduleRender({ scroll: false });
                    }
                };
            }
        }

        function switchMode(mode) {
            updateState('mode', mode);
            document.getElementById('nav-gen').classList.toggle('active', mode === 'gen');
            document.getElementById('nav-merge').classList.toggle('active', mode === 'merge');
            document.getElementById('sidebar-gen').classList.toggle('hidden', mode !== 'gen');
            document.getElementById('sidebar-merge').classList.toggle('hidden', mode !== 'merge');
            document.getElementById('canvas-wrapper').classList.toggle('hidden', mode !== 'gen');
            document.getElementById('merger-wrapper').classList.toggle('hidden', mode !== 'merge');

            if (mode === 'merge') {
                const radios = document.getElementsByName('merge-footer-mode');
                radios.forEach(r => r.checked = (r.value === state.footerMode));

                const mergeAdInput = document.getElementById('merge-in-ad');
                mergeAdInput.value = state.adText;
                if (state.footerMode === 'text') mergeAdInput.classList.remove('hidden');
                else mergeAdInput.classList.add('hidden');
            } else {
                const radios = document.getElementsByName('footer-mode');
                radios.forEach(r => r.checked = (r.value === state.footerMode));

                const adInput = document.getElementById('in-ad');
                adInput.value = state.adText;
                if (state.footerMode === 'text') adInput.classList.remove('hidden');
                else adInput.classList.add('hidden');
            }

            const btnSpan = document.querySelector('#export-btn span');
            if (mode === 'gen') btnSpan.innerText = '‰∏ãËºâ';
            else btnSpan.innerText = (state.mergeOverlays.length > 1) ? 'ÊâπÈáè‰∏ãËºâ' : '‰∏ãËºâ';

            adjustScale();
            if (mode === 'merge') renderMerger();
        }

        function switchStyle(id) {
            updateState('style', id);
            styleConfigs.forEach(s => {
                const b = document.getElementById(`btn-${s.id}`);
                const isActive = s.id === id;
                b.className = `p-2 border rounded-lg flex flex-col items-center gap-1 transition-all ${isActive ? 'border-rose-500 bg-rose-50 ring-1 ring-rose-200' : 'border-slate-200 hover:bg-slate-50'}`;
                const icon = b.querySelector('i') || b.querySelector('svg');
                if (icon) {
                    icon.classList.remove('text-rose-500', 'text-slate-400');
                    icon.classList.add(isActive ? 'text-rose-500' : 'text-slate-400');
                }
            });
            scheduleRender({ scroll: false });
        }

        function adjustScale() {
            const wrap = document.getElementById('preview-section');
            if (!wrap) return;
            const availableWidth = wrap.clientWidth;
            let scale = (availableWidth - 32) / APP_CONFIG.width;
            if (scale > 0.35) scale = 0.35;
            if (scale < 0.15) scale = 0.15;
            state.previewScale = scale;
            document.documentElement.style.setProperty('--preview-scale', state.previewScale);
        }

        function selectCard(index) {
            state.selectedCardIndex = index;
            state.activeIcon = null;
            scheduleRender({ scroll: true });
        }

        function addIconToSelectedCard(src) {
            if (!state.cardIcons[state.selectedCardIndex]) state.cardIcons[state.selectedCardIndex] = [];
            if (state.cardIcons[state.selectedCardIndex].length >= 5) { alert("ÊúÄÂ§ö 5 ÂÄãË≤ºÁ¥ô"); return; }

            const newIdx = state.cardIcons[state.selectedCardIndex].length;
            state.cardIcons[state.selectedCardIndex].push({ id: Date.now(), src: src, x: 800, y: 1000, scale: 1.0, flipX: false });
            state.activeIcon = { cardIdx: state.selectedCardIndex, iconIdx: newIdx };

            const slider = document.getElementById('icon-scale-slider');
            if (slider) slider.value = 1.0;
            document.getElementById('icon-scale-val').innerText = '1.0x';

            persistState();
            scheduleRender({ scroll: true });
        }

        function handleImgUpload(e, type) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                if (type === 'base') updateState('uploadedBaseImg', ev.target.result);
                else if (type === 'ip') addIconToSelectedCard(ev.target.result);
                else if (type === 'cover') updateState('coverImg', ev.target.result);
                scheduleRender({ scroll: false });
            };
            reader.readAsDataURL(file);
        }

        function handleMergerUpload(e, type) {
            const files = e.target.files;
            if (!files.length) return;

            if (type === 'bg') {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    updateState('mergeBg', ev.target.result);
                    renderMerger();
                };
                reader.readAsDataURL(files[0]);
            } else if (type === 'overlay') {
                const promises = Array.from(files).map(file => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (ev) => resolve(ev.target.result);
                        reader.readAsDataURL(file);
                    });
                });

                Promise.all(promises).then(results => {
                    updateState('mergeOverlays', results);
                    state.currentMergeIndex = 0;
                    renderMerger();
                    if (state.mode === 'merge') {
                        document.querySelector('#export-btn span').innerText = (results.length > 1) ? 'ÊâπÈáè‰∏ãËºâ' : '‰∏ãËºâ';
                    }
                });
            }
        }

        function changeMergeSlide(dir) {
            const newIndex = state.currentMergeIndex + dir;
            if (newIndex >= 0 && newIndex < state.mergeOverlays.length) {
                state.currentMergeIndex = newIndex;
                renderMerger();
            }
        }

        function renderMerger() {
            const bgEl = document.getElementById('merge-bg-el');
            const overEl = document.getElementById('merge-overlay-el');
            const prevBtn = document.getElementById('merge-prev');
            const nextBtn = document.getElementById('merge-next');
            const title = document.getElementById('preview-title');

            if (state.mergeBg) {
                bgEl.style.backgroundImage = `url(${state.mergeBg})`;
                bgEl.style.backgroundSize = 'cover';
                bgEl.style.backgroundRepeat = 'no-repeat';
                bgEl.style.backgroundColor = 'transparent';
                bgEl.classList.remove('hidden');
            }
            else if (state.useDefaultBgMerger) {
                bgEl.style.backgroundImage = `url('${APP_CONFIG.bgUrl}')`;
                bgEl.style.backgroundSize = 'repeat';
                bgEl.style.backgroundRepeat = 'repeat';
                bgEl.style.backgroundColor = '#f8fafc';
                bgEl.classList.remove('hidden');
            }
            else {
                bgEl.style.backgroundImage = '';
                bgEl.style.backgroundColor = '#ffffff';
                bgEl.classList.remove('hidden');
            }

            if (state.mergeOverlays.length > 0) {
                overEl.src = state.mergeOverlays[state.currentMergeIndex];
                overEl.classList.remove('hidden');

                if (state.mode === 'merge') {
                    title.innerText = `È†êË¶Ω ${state.currentMergeIndex + 1} / ${state.mergeOverlays.length}`;
                }

                if (state.mergeOverlays.length > 1) {
                    prevBtn.classList.remove('hidden');
                    nextBtn.classList.remove('hidden');
                    prevBtn.classList.toggle('disabled', state.currentMergeIndex === 0);
                    nextBtn.classList.toggle('disabled', state.currentMergeIndex === state.mergeOverlays.length - 1);
                } else {
                    prevBtn.classList.add('hidden');
                    nextBtn.classList.add('hidden');
                }
            } else {
                overEl.src = '';
                overEl.classList.add('hidden');
                prevBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
                if (state.mode === 'merge') title.innerText = 'È†êË¶ΩÂçÄ';
            }

            // Update Merger Footer
            const footer = document.querySelector('#merger-card .area-footer');
            if (footer) {
                let fc = '';
                let num = state.currentMergeIndex + 1;
                let total = Math.max(state.mergeOverlays.length, 1);

                if (state.footerMode === 'text') fc = `<div class="footer-pill text-sm">${state.adText}</div>`;
                else if (state.footerMode === 'pagenum') fc = `<div class="footer-simple">${num} / ${total}</div>`;
                footer.innerHTML = fc;
            }
        }

        // --- NEW: Forced Pagination Logic ---
        function calculatePages(rawText) {
            const segments = rawText.split(/\n-{3,}\n/g);

            const pages = [];

            const m = document.getElementById('measurer');
            m.className = `style-${state.style} md-content`;
            if (['journal', 'playful', 'comic'].includes(state.style)) { m.style.fontFamily = 'Zen Maru Gothic, sans-serif'; }
            else if (['luxury', 'paper', 'ink', 'retro', 'frame'].includes(state.style)) { m.style.fontFamily = 'Noto Serif TC, serif'; }
            else { m.style.fontFamily = 'Noto Sans TC, sans-serif'; }

            const maxH = APP_CONFIG.height - APP_CONFIG.headerHeight - APP_CONFIG.footerHeight - APP_CONFIG.contentPadding * 2;

            segments.forEach(segment => {
                if (!segment.trim()) return;

                let currentSet = [];
                let currentH = 0;

                const fullHtml = marked.parse(segment);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = fullHtml;
                const nodes = Array.from(tempDiv.children);

                nodes.forEach(node => {
                    m.innerHTML = ''; m.appendChild(node.cloneNode(true));
                    const h = m.offsetHeight + 24;
                    if (currentH + h > maxH && currentSet.length > 0) {
                        pages.push(currentSet);
                        currentSet = [node.outerHTML];
                        currentH = h;
                    } else {
                        currentSet.push(node.outerHTML);
                        currentH += h;
                    }
                });
                if (currentSet.length > 0) pages.push(currentSet);
            });

            if (pages.length === 0 && rawText.trim().length > 0) return [[marked.parse(rawText)]];
            else if (pages.length === 0) return [[]];
            return pages;
        }

        function getBackgroundStyle() {
            if (state.uploadedBaseImg) return `url(${state.uploadedBaseImg})`;
            if (state.useDefaultBg) return `url('${APP_CONFIG.bgUrl}')`;
            return 'none';
        }

        function renderGen(options = { scroll: false }) {
            const wrapper = document.getElementById('canvas-wrapper');
            const previewSection = document.getElementById('preview-section');
            if (!wrapper) return;

            const currentScroll = previewSection.scrollTop;

            const pages = calculatePages(state.content);
            const totalCards = pages.length + 1;

            if (state.selectedCardIndex >= totalCards) state.selectedCardIndex = 0;

            let existing = Array.from(wrapper.children).filter(c => c.classList.contains('card-wrapper'));

            if (existing.length < totalCards) {
                for (let i = existing.length; i < totalCards; i++) {
                    const cw = document.createElement('div');
                    cw.className = 'card-wrapper';
                    cw.onclick = () => selectCard(i);
                    cw.innerHTML = `
                        <div class="card-container">
                            <div class="area-header"></div>
                            <div class="area-content md-content"></div>
                            <div class="ip-layer"></div>
                            <div class="area-footer"></div>
                        </div>
                    `;
                    wrapper.appendChild(cw);
                }
            }

            while (wrapper.children.length > totalCards) {
                wrapper.removeChild(wrapper.lastChild);
            }

            existing = Array.from(wrapper.children).filter(c => c.classList.contains('card-wrapper'));

            existing.forEach((cw, i) => {
                const container = cw.querySelector('.card-container');
                const contentArea = cw.querySelector('.area-content');
                const footerArea = cw.querySelector('.area-footer');
                const ipLayer = cw.querySelector('.ip-layer');

                cw.className = `card-wrapper ${state.selectedCardIndex === i ? 'selected' : ''}`;
                cw.onclick = () => selectCard(i);

                container.className = `card-container style-${state.style}`;
                container.style.setProperty('--theme', state.theme);

                container.style.backgroundImage = getBackgroundStyle();
                container.style.backgroundSize = 'cover';
                if (state.useDefaultBg && !state.uploadedBaseImg) {
                    container.style.backgroundSize = 'repeat';
                    container.style.backgroundColor = '#f0f0f0';
                } else if (!state.uploadedBaseImg) {
                    container.style.backgroundColor = '#ffffff';
                }

                const isCover = (i === 0);
                let html = '';
                if (isCover) html = renderCover();
                else {
                    const pageItems = pages[i - 1] || [];
                    html = renderContent(pageItems);
                }

                if (state.style === 'frame') html = `<div class="frame-border">${html}</div>`;

                if (contentArea.innerHTML !== html) contentArea.innerHTML = html;

                let fc = '';
                if (state.footerMode === 'text') fc = `<div class="footer-pill text-sm">${state.adText}</div>`;
                else if (state.footerMode === 'pagenum') fc = `<div class="footer-simple">${i + 1} / ${totalCards}</div>`;
                if (footerArea.innerHTML !== fc) footerArea.innerHTML = fc;

                const icons = state.cardIcons[i] || [];
                const iconsHtml = icons.map((icon, idx) => {
                    const isActive = state.activeIcon && state.activeIcon.cardIdx === i && state.activeIcon.iconIdx === idx;
                    const activeClass = isActive ? 'active-icon' : '';
                    const scale = icon.scale || 1.0;
                    const isFlipped = icon.flipX || false;

                    return `
                    <div class="draggable-ip ${activeClass}" 
                         style="transform: translate(${icon.x}px, ${icon.y}px) scale(${scale}) ${isFlipped ? 'scaleX(-1)' : ''};" 
                         data-card-index="${i}" 
                         data-icon-index="${idx}" 
                         data-scale="${scale}"
                         data-flip="${isFlipped}"
                         onpointerdown="onIpStart(event)">
                        <img src="${icon.src}" class="w-full pointer-events-none">
                        <button class="absolute -top-3 -right-3 bg-red-500 text-white rounded-full p-1 shadow-md" onpointerdown="removeIcon(event, ${i}, ${idx})"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                    </div>`;
                }).join('');
                if (ipLayer.innerHTML !== iconsHtml) ipLayer.innerHTML = iconsHtml;
            });

            lucide.createIcons();

            if (options.scroll) {
                const selectedEl = wrapper.children[state.selectedCardIndex];
                if (selectedEl) {
                    // Manual scroll calculation
                    const container = wrapper;
                    const cardTop = selectedEl.offsetTop;
                    const cardHeight = selectedEl.offsetHeight;
                    const containerHeight = container.clientHeight;

                    const targetScroll = cardTop + (cardHeight / 2) - (containerHeight / 2);

                    container.scrollTo({
                        top: targetScroll,
                        behavior: 'smooth'
                    });
                }
            }
        }

        function removeIcon(e, cIdx, iIdx) {
            e.stopPropagation();
            state.cardIcons[cIdx].splice(iIdx, 1);
            if (state.activeIcon && state.activeIcon.cardIdx === cIdx && state.activeIcon.iconIdx === iIdx) {
                state.activeIcon = null;
            }
            persistState();
            scheduleRender({ scroll: false });
        }

        // ... Render Templates (Same as v21) ...
        function renderCover() {
            const t = state.title.replace(/\n/g, '<br>');
            const a = state.author;

            const renderAuth = (htmlStr) => state.showAuthor ? htmlStr : '';
            const coverPop = state.coverImg ? `<img src="${state.coverImg}" class="cover-pop" />` : '';
            const swipeHint = `<div class="swipe-hint">Swipe ‚ûî</div>`;

            let content = '';

            switch (state.style) {
                case 'neon': // New
                    content = `<div class="h-full flex flex-col justify-center p-16"><div class="neon-border"><h1 class="text-[90px] font-black leading-tight mb-8" style="text-shadow: 0 0 20px var(--theme);">${t}</h1>${renderAuth(`<p class="text-3xl font-bold tracking-[4px] uppercase" style="color:var(--theme); text-shadow:0 0 10px var(--theme);">@${a}</p>`)}</div></div>`;
                    break;
                case 'blob': // New
                    content = `<div class="h-full flex flex-col justify-center items-center p-12"><div class="blob-shape"></div><div class="blob-content text-center"><h1 class="text-[90px] font-black leading-none mb-10 text-slate-800">${t}</h1>${renderAuth(`<div class="w-20 h-2 bg-slate-800 mx-auto mb-6"></div><p class="text-3xl font-bold tracking-widest text-slate-500">${a}</p>`)}</div></div>`;
                    break;
                case 'cutout': // New
                    content = `<div class="h-full flex flex-col justify-center p-16"><h1 class="text-[100px] font-black leading-none mb-4 cutout-text">${t}</h1>${renderAuth(`<p class="text-4xl font-bold text-white/80 tracking-wide">${a}</p>`)}</div>`;
                    break;
                case 'checklist': // New
                    const lines = state.content.split('\n');
                    const items = lines.filter(l => l.trim().match(/^[-*]|\d+\./)).slice(0, 3);
                    const listHtml = items.length ? items.map(i => `<div class="check-item"><div class="check-box"><i data-lucide="check" size="24"></i></div><span class="text-3xl font-bold">${i.replace(/^[-*]|\d+\.\s*/, '')}</span></div>`).join('') : '';
                    content = `<div class="h-full flex flex-col justify-center p-16"><h1 class="text-[80px] font-black leading-tight text-slate-800 mb-12">${t}</h1>${listHtml ? `<div class="mb-10">${listHtml}</div>` : ''}${renderAuth(`<p class="text-2xl text-slate-400 font-bold">${a}</p>`)}</div>`;
                    break;

                case 'minimal': content = `<div class="h-full flex flex-col justify-center items-start p-10"><div class="min-line"></div><h1 class="text-[90px] font-black leading-tight text-slate-800 mb-8">${t}</h1>${renderAuth(`<p class="text-3xl text-slate-500 font-medium">@${a}</p>`)}</div>`; break;
                case 'poster': content = `<div class="h-full flex flex-col justify-center items-center text-center p-12"><div class="poster-box"><h1 class="text-[90px] font-black leading-none mb-10" style="color: var(--theme);">${t}</h1>${renderAuth(`<div class="w-full h-1 bg-white/30 mb-8"></div><p class="text-3xl font-bold tracking-widest uppercase">${a}</p>`)}</div></div>`; break;
                case 'memo': content = `<div class="h-full flex flex-col justify-center p-12"><div class="sticky-note"><h1 class="text-[80px] font-bold leading-tight mb-8">${t}</h1>${renderAuth(`<p class="text-3xl opacity-70">‚úçÔ∏è ${a}</p>`)}</div></div>`; break;
                case 'journal': content = `<div class="h-full flex flex-col justify-center items-center p-12"><div class="journal-card text-center"><h1 class="text-[85px] font-bold text-[#be123c] leading-tight mb-6">${t}</h1>${renderAuth(`<p class="text-3xl text-[#fb7185] font-medium">By ${a}</p>`)}</div></div>`; break;
                case 'glass': content = `<div class="h-full flex flex-col justify-center p-12"><div class="glass-panel"><h1 class="text-[85px] font-black text-slate-800 tracking-tight leading-none mb-8">${t}</h1>${renderAuth(`<p class="text-3xl font-bold text-slate-600">${a}</p>`)}</div></div>`; break;
                case 'cyber': content = `<div class="h-full flex flex-col justify-center p-12"><div class="aura-box"><h1 class="text-[90px] font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-violet-500 leading-tight mb-6">${t}</h1>${renderAuth(`<p class="text-3xl text-slate-500 font-bold">${a}</p>`)}</div></div>`; break;
                case 'luxury': content = `<div class="h-full flex flex-col justify-center items-center text-center p-16"><div class="mag-line"></div><h1 class="text-[90px] leading-tight mb-6 font-serif italic text-slate-800">${t}</h1>${renderAuth(`<div class="mag-line"></div><p class="text-2xl tracking-[4px] uppercase text-slate-500">${a}</p>`)}</div>`; break;
                case 'pop': content = `<div class="h-full flex flex-col justify-center items-center"><div class="pop-card transform rotate-2"><h1 class="text-[80px] leading-none font-black text-slate-900">${t}</h1></div>${renderAuth(`<div class="mt-10 bg-black text-white px-8 py-3 rounded-full text-3xl font-bold transform -rotate-2">${a}</div>`)}</div>`; break;
                case 'dry': content = `<div class="h-full flex flex-col justify-center p-12"><div class="floating-card"><h1 class="text-[85px] font-black leading-tight text-slate-800 mb-8">${t}</h1>${renderAuth(`<div class="flex items-center gap-4"><div class="w-12 h-12 bg-rose-100 rounded-full flex items-center justify-center text-2xl">üëÄ</div><span class="text-2xl font-bold text-slate-500">${a}</span></div>`)}</div></div>`; break;
                case 'paper': content = `<div class="h-full flex flex-col justify-center p-16"><div class="paper-sheet"><h1 class="text-[80px] font-bold mb-8 border-b-2 border-[#d6cfc7] pb-8 leading-tight">${t}</h1>${renderAuth(`<p class="text-3xl text-right italic font-serif text-[#78716c]">- ${a}</p>`)}</div></div>`; break;
                case 'solid': content = `<div class="h-full flex flex-col justify-center p-16"><div class="solid-content"><h1 class="text-[100px] font-black leading-tight mb-8 drop-shadow-sm">${t}</h1>${renderAuth(`<p class="text-3xl font-medium opacity-90">${a}</p>`)}</div></div>`; break;
                case 'brutal': content = `<div class="h-full flex flex-col justify-center p-10"><div class="outline-box"><h1 class="text-[90px] font-black leading-none mb-6 text-slate-900">${t}</h1>${renderAuth(`<div class="bg-black text-white px-6 py-2 inline-block text-2xl font-bold rounded-full">${a}</div>`)}</div></div>`; break;
                case 'retro': content = `<div class="h-full flex flex-col justify-center p-16"><div class="film-frame"><h1 class="text-[80px] font-bold mb-8 leading-tight text-slate-800">${t}</h1>${renderAuth(`<p class="text-2xl font-serif italic text-slate-500">Captured by ${a}</p>`)}</div></div>`; break;
                case 'dark': content = `<div class="h-full flex flex-col justify-center p-16"><div class="dark-card"><h1 class="text-[85px] font-bold leading-tight text-white mb-6">${t}</h1>${renderAuth(`<p class="text-2xl text-slate-400 font-medium">@${a}</p>`)}</div></div>`; break;
                case 'comic': content = `<div class="h-full flex flex-col justify-center items-center"><div class="doodle-box"><h1 class="text-[85px] font-black leading-tight text-center text-slate-800">${t}</h1></div></div>`; break;
                case 'elegant': content = `<div class="h-full p-16 flex flex-col justify-center"><h1 class="text-[90px] font-light leading-snug mb-8 text-slate-700">${t}</h1>${renderAuth(`<p class="text-xl tracking-[4px] uppercase text-slate-400 font-bold border-t border-slate-200 pt-8 inline-block w-full">${a}</p>`)}</div>`; break;
                case 'playful': content = `<div class="h-full flex flex-col justify-center items-center"><div class="soft-blob"><h1 class="text-[85px] font-bold text-[#ea580c] leading-tight text-center">${t}</h1></div></div>`; break;
                case 'tech': content = `<div class="h-full flex flex-col justify-center p-12"><div class="tech-card"><h1 class="text-[80px] font-bold leading-tight mb-6 text-slate-800">${t}</h1>${renderAuth(`<p class="text-xl text-slate-400 font-bold tracking-wide">INSIGHTS // ${a}</p>`)}</div></div>`; break;
                case 'ink': content = `<div class="h-full flex flex-col justify-center items-center p-16"><div class="zen-circle">Â≠ó</div><h1 class="text-[90px] font-bold leading-tight text-stone-700 text-center mb-8">${t}</h1>${renderAuth(`<p class="text-2xl text-stone-500 font-serif italic">${a}</p>`)}</div>`; break;
                case 'boxy': content = `<div class="h-full flex flex-col justify-center p-16"><div class="grid-unit"><h1 class="text-[85px] font-black leading-tight text-slate-800 mb-6">${t}</h1>${renderAuth(`<p class="text-2xl text-slate-500 font-bold text-right"># ${a}</p>`)}</div></div>`; break;
                case 'frame': content = `<div class="h-full p-16"><div class="frame-border justify-center"><h1 class="text-[90px] font-black leading-tight mb-12 text-slate-800 text-center">${t}</h1>${renderAuth(`<div class="flex justify-center"><div class="px-8 py-3 bg-slate-100 rounded-full text-2xl font-bold text-slate-500">${a}</div></div>`)}</div></div>`; break;
                default: content = `<div class="h-full flex flex-col justify-center"><h1 class="text-[90px] font-black">${t}</h1></div>`;
            }

            return `<div class="relative w-full h-full">${content}${coverPop}${swipeHint}</div>`;
        }

        function renderContent(items) {
            if (!items) return '';
            const c = items.join('');
            if (state.style === 'poster') return `<div class="poster-box">${c}</div>`;
            if (state.style === 'dry') return `<div class="floating-card">${c}</div>`;
            if (state.style === 'memo') return `<div class="sticky-note">${c}</div>`;
            if (state.style === 'journal') return `<div class="journal-card">${c}</div>`;
            if (state.style === 'cyber') return `<div class="aura-box">${c}</div>`;
            if (state.style === 'pop') return `<div class="pop-card">${c}</div>`;
            if (state.style === 'glass') return `<div class="glass-panel">${c}</div>`;
            if (state.style === 'paper') return `<div class="paper-sheet">${c}</div>`;
            if (state.style === 'solid') return `<div class="solid-content">${c}</div>`;
            if (state.style === 'brutal') return `<div class="outline-box">${c}</div>`;
            if (state.style === 'retro') return `<div class="film-frame">${c}</div>`;
            if (state.style === 'dark') return `<div class="dark-card">${c}</div>`;
            if (state.style === 'comic') return `<div class="doodle-box">${c}</div>`;
            if (state.style === 'elegant') return `<div class="air-box">${c}</div>`;
            if (state.style === 'playful') return `<div class="soft-blob">${c}</div>`;
            if (state.style === 'tech') return `<div class="tech-card">${c}</div>`;
            if (state.style === 'ink') return `<div class="ink-content">${c}</div>`;
            if (state.style === 'boxy') return `<div class="grid-unit">${c}</div>`;
            if (state.style === 'neon') return `<div class="neon-border">${c}</div>`;
            if (state.style === 'checklist') return `<div class="px-4">${c}</div>`;
            if (state.style === 'cutout') return `<div class="cutout-text text-5xl leading-tight">${c}</div>`;
            return `<div>${c}</div>`;
        }

        // --- Pointer Event Drag Logic (Unified & Optimized) ---
        function onGlobalPointerMove(e) {
            if (!dragTarget) return;
            const dx = (e.clientX - startX) / state.previewScale;
            const dy = (e.clientY - startY) / state.previewScale;

            const scale = dragTarget.dataset.scale || 1;
            const isFlipped = dragTarget.dataset.flip === 'true';
            const flipTransform = isFlipped ? 'scaleX(-1)' : '';

            dragTarget.style.transform = `translate(${initialX + dx}px, ${initialY + dy}px) scale(${scale}) ${flipTransform}`;
        }

        function onIpStart(e) {
            if (e.target.closest('button')) return;
            e.preventDefault();
            dragTarget = e.currentTarget;
            startX = e.clientX;
            startY = e.clientY;

            const cIdx = parseInt(dragTarget.getAttribute('data-card-index'));
            const iIdx = parseInt(dragTarget.getAttribute('data-icon-index'));
            state.activeIcon = { cardIdx: cIdx, iconIdx: iIdx };

            if (state.cardIcons[cIdx] && state.cardIcons[cIdx][iIdx]) {
                const scale = state.cardIcons[cIdx][iIdx].scale || 1.0;
                const slider = document.getElementById('icon-scale-slider');
                if (slider) slider.value = scale;
                document.getElementById('icon-scale-val').innerText = parseFloat(scale).toFixed(1) + 'x';
                dragTarget.dataset.scale = scale;
                dragTarget.dataset.flip = state.cardIcons[cIdx][iIdx].flipX;
            }

            renderGen({ scroll: false });

            const newTarget = document.querySelector(`.draggable-ip[data-card-index="${cIdx}"][data-icon-index="${iIdx}"]`);
            if (newTarget) dragTarget = newTarget;

            const style = window.getComputedStyle(dragTarget);
            const matrix = new WebKitCSSMatrix(style.transform);
            initialX = matrix.m41;
            initialY = matrix.m42;

            dragTarget.style.cursor = 'grabbing';
            dragTarget.style.zIndex = 1000;
            dragTarget.setPointerCapture(e.pointerId);
        }

        function onGlobalPointerUp(e) {
            if (!dragTarget) return;

            const cIdx = parseInt(dragTarget.getAttribute('data-card-index'));
            const iIdx = parseInt(dragTarget.getAttribute('data-icon-index'));

            const style = window.getComputedStyle(dragTarget);
            const matrix = new WebKitCSSMatrix(style.transform);

            if (state.cardIcons[cIdx] && state.cardIcons[cIdx][iIdx]) {
                state.cardIcons[cIdx][iIdx].x = matrix.m41;
                state.cardIcons[cIdx][iIdx].y = matrix.m42;
                persistState();
            }

            dragTarget.style.cursor = 'grab';
            dragTarget.style.zIndex = '';
            dragTarget.releasePointerCapture(e.pointerId);
            dragTarget = null;
        }

        function handleExport() { state.mode === 'gen' ? downloadZip() : downloadMerger(); }

        async function downloadMerger() {
            const overlay = document.getElementById('export-overlay');
            const progress = document.getElementById('progress-val');
            const cardEl = document.getElementById('merger-card');
            const overlayEl = document.getElementById('merge-overlay-el');
            overlay.style.display = 'flex';
            try {
                if (state.mergeOverlays.length <= 1) {
                    const c = await html2canvas(cardEl, { scale: 1, width: APP_CONFIG.width, height: APP_CONFIG.height, useCORS: true, backgroundColor: '#ffffff' });
                    const a = document.createElement('a'); a.download = `Merger_${Date.now()}.png`; a.href = c.toDataURL(); a.click();
                } else {
                    const zip = new JSZip();
                    const originalIndex = state.currentMergeIndex;
                    for (let i = 0; i < state.mergeOverlays.length; i++) {
                        progress.innerText = `Processing ${i + 1} / ${state.mergeOverlays.length}`;
                        state.currentMergeIndex = i;
                        overlayEl.src = state.mergeOverlays[i];
                        await new Promise(resolve => { if (overlayEl.complete) resolve(); else overlayEl.onload = resolve; });
                        await new Promise(r => setTimeout(r, 50));
                        const canvas = await html2canvas(cardEl, { scale: 1, width: APP_CONFIG.width, height: APP_CONFIG.height, useCORS: true, backgroundColor: '#ffffff' });
                        const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
                        zip.file(`Merger_${i + 1}.png`, blob);
                    }
                    state.currentMergeIndex = originalIndex;
                    overlayEl.src = state.mergeOverlays[originalIndex];
                    progress.innerText = "Compressing...";
                    const content = await zip.generateAsync({ type: "blob" });
                    saveAs(content, `Batch_Merger_${Date.now()}.zip`);
                }
            } catch (e) { console.error(e); alert('Error generating image'); } finally { overlay.style.display = 'none'; }
        }

        async function downloadZip() {
            const overlay = document.getElementById('export-overlay');
            const progress = document.getElementById('progress-val');
            overlay.style.display = 'flex';
            await new Promise(r => setTimeout(r, 100));
            const zip = new JSZip();
            const cards = document.querySelectorAll('.card-wrapper');
            for (let i = 0; i < cards.length; i++) {
                if (cards[i].closest('#merger-wrapper')) continue;
                progress.innerText = `Card ${i + 1}`;
                const el = cards[i].querySelector('.card-container').cloneNode(true);
                el.style.transform = 'none'; el.style.position = 'fixed'; el.style.top = '0'; el.style.left = '-9999px';
                el.style.width = APP_CONFIG.width + 'px'; el.style.height = APP_CONFIG.height + 'px';
                el.querySelectorAll('button').forEach(b => b.remove());

                // Remove active borders for export
                el.querySelectorAll('.active-icon').forEach(ic => ic.classList.remove('active-icon', 'outline'));

                let bg = '#ffffff'; if (['poster'].includes(state.style)) bg = '#FCD34D';
                if (state.useDefaultBg && !state.uploadedBaseImg) { el.style.backgroundImage = `url('${APP_CONFIG.bgUrl}')`; el.style.backgroundSize = 'repeat'; }
                el.style.backgroundColor = bg;
                document.body.appendChild(el);
                const c = await html2canvas(el, { scale: 1, width: APP_CONFIG.width, height: APP_CONFIG.height, useCORS: true, backgroundColor: bg });
                document.body.removeChild(el);
                zip.file(`${i + 1}.png`, await new Promise(r => c.toBlob(r)));
            }
            saveAs(await zip.generateAsync({ type: 'blob' }), `VisualClone_${Date.now()}.zip`);
            overlay.style.display = 'none';
        }

        // --- JSON Export/Import ---
        function exportJSON() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "visual_clone_project.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const loadedState = JSON.parse(e.target.result);
                    Object.assign(state, loadedState);
                    persistState();
                    init();
                    alert('Â∞àÊ°àÂåØÂÖ•ÊàêÂäüÔºÅ');
                } catch (err) {
                    alert('ÁÑ°ÊïàÁöÑÂ∞àÊ°àÊ™îÊ°à');
                }
            };
            reader.readAsText(file);
        }

        function resetProject() {
            if (confirm('Á¢∫ÂÆöË¶ÅÈáçÁΩÆÂ∞àÊ°àÂóéÔºüÊâÄÊúâÂÖßÂÆπÂ∞áÊúÉÊ∏ÖÁ©∫„ÄÇ')) {
                localStorage.removeItem("visual_clone_project");
                location.reload();
            }
        }

        window.onload = init;
    </script>
</body>

</html>