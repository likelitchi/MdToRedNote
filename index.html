<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Visual Clone Pro Suite v14 (Render Fix & Footer)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=Noto+Serif+TC:wght@300;500;700;900&family=Zen+Maru+Gothic:wght@300;400;500;700;900&display=swap');

        :root {
            /* JS Â∞áÊ†πÊìö APP_CONFIG Êõ¥Êñ∞ÈÄô‰∫õËÆäÊï∏ */
            --canvas-w: 1080px;
            --canvas-h: 1350px;
            --header-h: 140px;
            --footer-h: -30px;
            --content-h: 1110px;
            --preview-scale: 0.35;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        /* --- Canvas Layout --- */
        .card-wrapper {
            position: relative;
            margin-bottom: 24px;
            width: calc(var(--canvas-w) * var(--preview-scale));
            height: calc(var(--canvas-h) * var(--preview-scale));
            transition: transform 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            flex-shrink: 0;
            margin-left: auto;
            margin-right: auto;
        }

        .card-container {
            width: var(--canvas-w);
            height: var(--canvas-h);
            background-color: white;
            position: absolute;
            top: 0;
            left: 0;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transform: scale(var(--preview-scale));
            transform-origin: top left;
            cursor: pointer;
            border-radius: 0px;
        }

        .card-wrapper.selected {
            transform: scale(1.02);
            z-index: 10;
        }

        .card-wrapper.selected .card-container {
            box-shadow: 0 0 0 4px #f43f5e, 0 20px 40px rgba(244, 63, 94, 0.2);
        }

        .area-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--header-h);
            z-index: 100;
            pointer-events: none;
        }

        .area-footer {
            position: absolute;
            bottom: -20px;
            left: 0;
            width: 100%;
            height: var(--footer-h);
            z-index: 100;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .area-content {
            position: absolute;
            top: var(--header-h);
            left: 0;
            width: 100%;
            height: var(--content-h);
            padding: 20px 90px;
            box-sizing: border-box;
            z-index: 10;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* --- Footer Styles --- */
        .footer-pill {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 10px 32px;
            border-radius: 100px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            font-weight: 700;
            color: #475569;
            font-size: 22px;
            letter-spacing: 1px;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* ÈóúÈçµÊõ¥Êñ∞ÔºöÊÅ¢Âæ© Simple Footer È°ØÁ§∫ */
        .footer-simple {
            color: #94a3b8;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 4px;
            font-family: 'Noto Sans TC', sans-serif;
            /* ÁßªÈô§‰∫ÜÈö±ËóèÂ±¨ÊÄßÔºåÁèæÂú®ÊúÉÊ≠£Â∏∏È°ØÁ§∫ */
        }

        /* --- Markdown Styles (Whitespace Preserved) --- */
        .md-content h1 {
            font-size: 64px;
            font-weight: 900;
            line-height: 1.2;
            margin-bottom: 24px;
            white-space: pre-wrap;
        }

        .md-content h2 {
            font-size: 56px;
            font-weight: 800;
            line-height: 1.2;
            margin-bottom: 20px;
            margin-top: 10px;
            white-space: pre-wrap;
        }

        .md-content h3 {
            font-size: 48px;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 16px;
            white-space: pre-wrap;
        }

        .md-content p {
            font-size: 36px;
            line-height: 1.6;
            margin-bottom: 24px;
            white-space: pre-wrap;
        }

        .md-content ul {
            list-style-type: disc;
            padding-left: 1.2em;
            margin-bottom: 24px;
        }

        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.2em;
            margin-bottom: 24px;
        }

        .md-content li {
            font-size: 36px;
            line-height: 1.6;
            margin-bottom: 12px;
            white-space: pre-wrap;
        }

        .md-content blockquote {
            border-left: 8px solid #cbd5e1;
            padding-left: 24px;
            font-style: italic;
            opacity: 0.8;
            margin-bottom: 24px;
            white-space: pre-wrap;
        }

        .md-content strong {
            font-weight: 900;
            color: inherit;
        }

        .md-content code {
            background: rgba(0, 0, 0, 0.08);
            padding: 4px 8px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
        }

        /* --- Styles Definition --- */
        .style-minimal {
            font-family: 'Noto Sans TC';
            background: #fff;
            color: #1e293b;
        }

        .style-minimal .min-line {
            width: 60px;
            height: 6px;
            background: #0f172a;
            margin: 40px 0;
            border-radius: 10px;
        }

        .style-poster {
            font-family: 'Noto Sans TC';
            background: #FCD34D;
            color: #fff;
        }

        .style-poster .poster-box {
            background: #1e293b;
            color: #fff !important;
            padding: 40px 50px;
            width: 100%;
            box-shadow: 20px 20px 0px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }

        .style-poster .poster-box h1,
        .style-poster .poster-box h2 {
            color: #FCD34D !important;
        }

        .style-memo {
            font-family: 'Noto Sans TC';
            background: #fffbeb;
            color: #4b5563;
            background-image: linear-gradient(#e5e7eb 1px, transparent 1px), linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
            background-size: 40px 40px;
        }

        .style-memo .sticky-note {
            background: #fef3c7;
            padding: 40px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: rotate(-1deg);
            border-radius: 2px;
            color: #451a03;
            margin-bottom: 30px;
        }

        .style-journal {
            font-family: 'Zen Maru Gothic';
            background: #fff1f2;
            color: #881337;
        }

        .style-journal .journal-card {
            background: rgba(255, 255, 255, 0.8);
            border: 2px dashed #f43f5e;
            border-radius: 40px;
            padding: 40px;
            margin-bottom: 24px;
        }

        .style-glass {
            font-family: 'Noto Sans TC';
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            color: #1e293b;
        }

        .style-glass .glass-panel {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(40px);
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.6);
            padding: 40px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
            margin-bottom: 24px;
        }

        .style-cyber {
            font-family: 'Noto Sans TC';
            background: #fff;
            color: #334155;
            overflow: hidden;
        }

        .style-cyber::before {
            content: "";
            position: absolute;
            top: -20%;
            right: -20%;
            width: 800px;
            height: 800px;
            background: radial-gradient(circle, #fbcfe8 0%, transparent 70%);
            opacity: 0.8;
            z-index: 0;
        }

        .style-cyber .aura-box {
            position: relative;
            z-index: 10;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.8);
            margin-bottom: 24px;
        }

        .style-luxury {
            font-family: 'Noto Serif TC';
            background: #f8fafc;
            color: #1e293b;
        }

        .style-luxury .mag-line {
            width: 100%;
            height: 1px;
            background: #94a3b8;
            margin: 30px 0;
        }

        .style-luxury h1,
        .style-luxury h2 {
            font-style: italic;
        }

        .style-pop {
            font-family: 'Noto Sans TC';
            background: #ffedd5;
            color: #1e293b;
        }

        .style-pop .pop-card {
            background: #fff;
            border: 3px solid #000;
            box-shadow: 12px 12px 0 #fb923c;
            padding: 40px;
            border-radius: 16px;
            margin-bottom: 30px;
        }

        .style-dry {
            font-family: 'Noto Sans TC';
            background: #f1f5f9;
            color: #334155;
        }

        .style-dry .floating-card {
            background: #fff;
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
        }

        .style-paper {
            font-family: 'Noto Serif TC';
            background: #fdf6e3;
            color: #433422;
        }

        .style-paper .paper-sheet {
            background: #fff;
            padding: 50px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-radius: 2px;
            margin-bottom: 24px;
        }

        .style-solid {
            font-family: 'Noto Sans TC';
            background: var(--theme);
            color: white;
        }

        .style-solid .solid-content {
            border-left: 6px solid rgba(255, 255, 255, 0.4);
            padding-left: 40px;
            margin-bottom: 30px;
        }

        .style-brutal {
            font-family: 'Noto Sans TC';
            background: #fff;
            color: #000;
        }

        .style-brutal .outline-box {
            border: 3px solid #000;
            padding: 30px;
            border-radius: 24px;
            background: #fff;
            margin-bottom: 24px;
        }

        .style-retro {
            font-family: 'Noto Serif TC';
            background: #e2e8f0;
            color: #1e293b;
        }

        .style-retro .film-frame {
            background: #fff;
            padding: 60px 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            border: 1px solid #cbd5e1;
        }

        .style-dark {
            font-family: 'Noto Sans TC';
            background: #0f172a;
            color: #e2e8f0;
        }

        .style-dark .dark-card {
            background: #1e293b;
            border-radius: 20px;
            padding: 40px;
            border: 1px solid #334155;
            margin-bottom: 24px;
        }

        .style-comic {
            font-family: 'Zen Maru Gothic';
            background: #fff;
            color: #333;
            background-image: radial-gradient(#e2e8f0 2px, transparent 2px);
            background-size: 20px 20px;
        }

        .style-comic .doodle-box {
            border: 3px solid #333;
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            padding: 40px;
            background: #fff;
            margin-bottom: 30px;
        }

        .style-elegant {
            font-family: 'Noto Sans TC';
            background: #fafafa;
            color: #525252;
        }

        .style-elegant .air-box {
            padding: 30px 0;
            border-left: 2px solid #d4d4d4;
            padding-left: 40px;
            margin-bottom: 20px;
        }

        .style-playful {
            font-family: 'Zen Maru Gothic';
            background: #fff7ed;
            color: #7c2d12;
        }

        .style-playful .soft-blob {
            background: #ffedd5;
            border-radius: 30px;
            padding: 40px;
            margin-bottom: 24px;
        }

        .style-tech {
            font-family: 'Noto Sans TC';
            background: #f8fafc;
            color: #334155;
        }

        .style-tech .tech-card {
            border-left: 6px solid var(--theme);
            background: white;
            padding: 40px;
            border-radius: 0 16px 16px 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            margin-bottom: 24px;
        }

        .style-ink {
            font-family: 'Noto Serif TC';
            background: #f5f5f4;
            color: #44403c;
        }

        .style-ink .zen-circle {
            border: 1px solid #a8a29e;
            border-radius: 50%;
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 40px;
            color: #d6d3d1;
        }

        .style-ink .ink-content {
            border-left: 4px solid #d6d3d1;
            padding-left: 30px;
            margin-bottom: 30px;
        }

        .style-boxy {
            font-family: 'Noto Sans TC';
            background: #f1f5f9;
            color: #334155;
        }

        .style-boxy .grid-unit {
            background: #fff;
            padding: 36px;
            margin-bottom: 20px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .style-frame {
            font-family: 'Noto Serif TC';
            background: #f8fafc;
            color: #334155;
        }

        .style-frame .frame-border {
            border: 4px double #94a3b8;
            height: 100%;
            padding: 50px 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: #fff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }

        /* IP Layer */
        .ip-layer {
            position: absolute;
            inset: 0;
            z-index: 200;
            pointer-events: none;
        }

        .draggable-ip {
            position: absolute;
            width: 250px;
            height: auto;
            cursor: grab;
            pointer-events: auto;
            user-select: none;
            will-change: transform;
            filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.15));
        }

        .draggable-ip:active {
            cursor: grabbing;
            transform: scale(1.05);
        }

        .draggable-ip:hover {
            border: 2px dashed rgba(244, 63, 94, 0.5);
        }

        #export-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.95);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .nav-btn.active {
            background-color: rgb(241, 245, 249);
            color: rgb(15, 23, 42);
        }

        .nav-btn {
            color: rgb(100, 116, 139);
        }

        .char-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .char-item {
            aspect-ratio: 1;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            transition: all 0.2s;
        }

        .char-item:hover {
            border-color: #f43f5e;
            background-color: #fff1f2;
            transform: translateY(-2px);
        }

        .char-item img {
            width: 70%;
            height: 70%;
            object-fit: contain;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            #preview-section {
                flex: 0 0 38% !important;
                min-height: 0;
            }
        }

        /* Nav controls for merger */
        .merger-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            z-index: 50;
            color: #475569;
            transition: all 0.2s;
        }

        .merger-nav-btn:hover {
            background: white;
            color: #0f172a;
            transform: translateY(-50%) scale(1.1);
        }

        .merger-nav-btn.disabled {
            opacity: 0.3;
            pointer-events: none;
        }
    </style>
</head>

<body class="bg-slate-50">

    <header
        class="shrink-0 h-14 bg-white border-b border-slate-200 flex items-center justify-between px-4 md:px-6 z-50">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
                <div
                    class="w-8 h-8 bg-rose-500 rounded-lg flex items-center justify-center text-white shadow-sm shadow-rose-200">
                    <i data-lucide="layers" size="18"></i>
                </div>
                <h1 class="text-lg font-bold tracking-tight text-slate-800 hidden md:block">Visual <span
                        class="text-rose-500">Suite v14</span></h1>
            </div>

            <div class="flex bg-slate-100 p-1 rounded-lg">
                <button onclick="switchMode('gen')" id="nav-gen"
                    class="nav-btn active px-3 py-1.5 rounded-md text-xs font-bold transition-all flex items-center gap-2">
                    <i data-lucide="pen-tool" size="14"></i> <span class="hidden md:inline">Âç°Áâá</span>
                </button>
                <button onclick="switchMode('merge')" id="nav-merge"
                    class="nav-btn px-3 py-1.5 rounded-md text-xs font-bold transition-all flex items-center gap-2">
                    <i data-lucide="scissors" size="14"></i> <span class="hidden md:inline">ÊãºÊé•</span>
                </button>
            </div>
        </div>

        <button onclick="handleExport()" id="export-btn"
            class="bg-rose-500 hover:bg-rose-600 text-white px-4 md:px-6 py-1.5 rounded-full font-bold flex items-center gap-2 transition-all shadow-lg shadow-rose-200 active:scale-95 text-xs md:text-sm">
            <i data-lucide="download" size="14"></i> <span id="dl-text">‰∏ãËºâ</span>
        </button>
    </header>

    <main class="flex-1 flex flex-col md:flex-row overflow-hidden h-full min-h-0">

        <!-- Preview Section -->
        <section id="preview-section"
            class="order-1 md:order-2 shrink-0 h-[38%] md:h-full md:flex-1 bg-slate-100 overflow-hidden flex flex-col relative border-b md:border-b-0 shadow-inner"
            style="flex: 0 0 38%; md:flex:1 1 0%;">
            <div
                class="mb-4 flex items-center gap-4 text-slate-400 bg-white px-4 py-1.5 rounded-full shadow-sm sticky top-4 z-30 opacity-80 md:opacity-100 scale-90 md:scale-100 origin-top mx-auto">
                <i data-lucide="mouse-pointer-2" size="14"></i>
                <span class="text-xs font-bold uppercase tracking-tighter" id="preview-title">È†êË¶ΩÂçÄ</span>
            </div>

            <div id="canvas-wrapper"
                class="flex-1 w-full overflow-y-auto custom-scroll p-4 pb-12 flex flex-col items-center min-h-0"></div>

            <div id="merger-wrapper" class="hidden flex-1 w-full h-full relative">
                <div id="merge-prev" class="merger-nav-btn left-4 hidden" onclick="changeMergeSlide(-1)"><i
                        data-lucide="chevron-left" size="24"></i></div>
                <div id="merge-next" class="merger-nav-btn right-4 hidden" onclick="changeMergeSlide(1)"><i
                        data-lucide="chevron-right" size="24"></i></div>

                <div class="w-full h-full overflow-y-auto custom-scroll p-4 pb-12 flex flex-col items-center min-h-0">
                    <div class="card-wrapper" style="margin-top: 0;">
                        <!-- Image container for merger -->
                        <div id="merger-card" class="card-container">
                            <!-- Background Element (CSS based) -->
                            <div id="merge-bg-el" class="absolute inset-0 w-full h-full hidden"
                                style="background-size: cover; background-position: center;"></div>
                            <div class="absolute top-[120px] bottom-[60px] left-0 w-full overflow-hidden z-10">
                                <img id="merge-overlay-el" class="w-full h-auto hidden" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sidebar -->
        <aside
            class="order-2 md:order-1 flex-1 md:flex-none md:w-[420px] bg-white border-r border-slate-200 flex flex-col overflow-hidden z-20 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] md:shadow-none min-h-0">
            <div class="flex-1 overflow-y-auto p-5 pb-10 md:pb-6 custom-scroll min-h-0"
                style="padding-bottom: env(safe-area-inset-bottom);">

                <div id="sidebar-gen" class="space-y-6 pb-8">
                    <section class="space-y-3">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">1. È¢®Ê†ºÈÅ∏Êìá</h3>
                        <div class="grid grid-cols-4 gap-2" id="style-selector"></div>
                    </section>
                    <section class="space-y-3">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">2. Á¥†ÊùêË®≠ÂÆö</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <label
                                class="border border-slate-200 rounded-lg p-3 flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50 transition-all bg-white h-20">
                                <i data-lucide="image" class="text-slate-400 mb-1" size="16"></i>
                                <span class="text-[10px] font-bold text-slate-600">ËÉåÊôØÂúñ</span>
                                <input type="file" class="hidden" accept="image/*"
                                    onchange="handleImgUpload(event, 'base')">
                            </label>
                            <label
                                class="border border-slate-200 rounded-lg p-3 flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50 transition-all bg-white h-20">
                                <i data-lucide="smile" class="text-slate-400 mb-1" size="16"></i>
                                <span class="text-[10px] font-bold text-slate-600">Ë≤ºÁ¥ô</span>
                                <input type="file" class="hidden" accept="image/*"
                                    onchange="handleImgUpload(event, 'ip')">
                            </label>
                        </div>
                        <div class="flex items-center gap-2 px-1">
                            <input type="checkbox" id="check-default-bg"
                                class="w-4 h-4 rounded text-rose-600 focus:ring-rose-500">
                            <label for="check-default-bg" class="text-xs text-slate-500 font-bold">‰ΩøÁî®ÈªòË™çËÉåÊôØ
                                (Base64)</label>
                        </div>
                        <div class="char-grid pt-2" id="default-chars"></div>
                    </section>
                    <section class="space-y-3">
                        <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest">3. ÂÖßÂÆπÊñáÊ°à</h3>
                        <input type="text" id="in-title"
                            class="w-full border border-slate-200 rounded-lg p-3 font-bold focus:ring-2 focus:ring-rose-500 outline-none text-slate-700 text-sm"
                            placeholder="Â∞ÅÈù¢Ê®ôÈ°å">
                        <input type="text" id="in-author"
                            class="w-full border border-slate-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-rose-500 outline-none text-slate-600"
                            placeholder="ÁΩ≤Âêç / IG">
                        <textarea id="in-content" rows="6"
                            class="w-full border border-slate-200 rounded-lg p-3 text-sm leading-relaxed focus:ring-2 focus:ring-rose-500 outline-none resize-none text-slate-600"
                            placeholder="ÂÖßÂÆπ (Markdown ÊîØÊè¥)"></textarea>
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 space-y-2">
                            <span class="text-xs font-bold text-slate-500">È†ÅÂ∞æÊ®°Âºè</span>
                            <div class="flex items-center gap-3">
                                <label class="flex items-center gap-1"><input type="radio" name="footer-mode"
                                        value="pagenum" class="text-rose-600"><span class="text-xs">È†ÅÁ¢º</span></label>
                                <label class="flex items-center gap-1"><input type="radio" name="footer-mode"
                                        value="text" class="text-rose-600"><span class="text-xs">ÊñáÂ≠ó</span></label>
                                <label class="flex items-center gap-1"><input type="radio" name="footer-mode"
                                        value="none" class="text-rose-600"><span class="text-xs">ÁÑ°</span></label>
                            </div>
                            <input type="text" id="in-ad"
                                class="w-full border border-slate-200 rounded p-2 text-xs hidden"
                                placeholder="Ëº∏ÂÖ•Êé®Âª£Ë™û...">
                        </div>
                    </section>
                    <section class="space-y-3">
                        <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest">4. ‰∏ªÈ°åËâ≤</h3>
                        <div id="theme-box" class="flex gap-3 overflow-x-auto pb-2"></div>
                    </section>
                </div>

                <div id="sidebar-merge" class="space-y-6 hidden pb-8">
                    <section class="space-y-4">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Èï∑ÂúñÊãºÊé• (Batch Merger)</h3>
                        <div class="flex items-center gap-2 mb-2">
                            <input type="checkbox" id="check-merger-default-bg" class="w-4 h-4 rounded text-rose-600">
                            <label for="check-merger-default-bg" class="text-xs font-bold text-slate-600">‰ΩøÁî®ÈªòË™çËÉåÊôØ</label>
                        </div>
                        <label
                            class="block border-2 border-dashed border-slate-200 rounded-xl p-4 text-center cursor-pointer hover:bg-blue-50">
                            <span class="text-xs font-bold block text-slate-500">‰∏äÂÇ≥ËÉåÊôØ (Base)</span>
                            <input type="file" class="hidden" onchange="handleMergerUpload(event, 'bg')">
                        </label>

                        <label
                            class="block border-2 border-dashed border-slate-200 rounded-xl p-4 text-center cursor-pointer hover:bg-blue-50 relative group">
                            <div
                                class="absolute inset-0 bg-blue-100 opacity-0 group-hover:opacity-20 transition-opacity rounded-xl">
                            </div>
                            <i data-lucide="files" class="mx-auto mb-2 text-blue-400"></i>
                            <span class="text-xs font-bold block text-slate-600">ÊâπÈáè‰∏äÂÇ≥Èï∑Âúñ (Overlays)</span>
                            <span class="text-[10px] text-slate-400 block mt-1">ÊîØÊè¥Â§öÈÅ∏Ôºå‰∏ÄÊ¨°ÁîüÊàê</span>
                            <input type="file" class="hidden" multiple onchange="handleMergerUpload(event, 'overlay')">
                        </label>

                        <div class="bg-blue-50 p-4 rounded-lg text-xs text-blue-800 leading-relaxed">
                            <p>üí° <b>ÊèêÁ§∫Ôºö</b></p>
                            <ul class="list-disc pl-4 mt-1 space-y-1">
                                <li>ÂèØ‰∏ÄÊ¨°ÈÅ∏ÂèñÂ§öÂºµÈï∑Êà™Âúñ„ÄÇ</li>
                                <li>ÊâÄÊúâÂúñÁâáÂ∞áÂ•óÁî®Âêå‰∏ÄÂºµËÉåÊôØÂúñ„ÄÇ</li>
                                <li>ÈªûÊìä„Äå‰∏ãËºâ„ÄçÂ∞áËá™ÂãïÊâìÂåÖÊâÄÊúâÊãºÊé•ÁµêÊûúÁÇ∫ ZIP„ÄÇ</li>
                            </ul>
                        </div>
                    </section>
                </div>

            </div>
        </aside>
    </main>

    <div id="export-overlay">
        <div class="animate-spin text-rose-400 mb-6"><i data-lucide="refresh-cw" size="64"></i></div>
        <h2 class="text-2xl font-black mb-2 tracking-tighter uppercase text-center">ËôïÁêÜ‰∏≠...</h2>
        <p class="text-slate-400 font-mono" id="progress-val">Initializing...</p>
    </div>

    <div id="measurer" class="md-content"
        style="position:absolute; visibility:hidden; width:900px; font-size:36px; line-height:1.6;"></div>

    <script>
        // --- APP CONFIGURATION ---
        const APP_CONFIG = {
            width: 1080,
            height: 1350,
            headerHeight: 120,
            footerHeight: 60,
            contentPadding: 60,
            bgUrl: 'frame.jpg'
        };

        const root = document.documentElement;
        root.style.setProperty('--canvas-w', APP_CONFIG.width + 'px');
        root.style.setProperty('--canvas-h', APP_CONFIG.height + 'px');
        root.style.setProperty('--header-h', APP_CONFIG.headerHeight + 'px');
        root.style.setProperty('--footer-h', APP_CONFIG.footerHeight + 'px');
        const contentH = APP_CONFIG.height - APP_CONFIG.headerHeight - APP_CONFIG.footerHeight - 20;
        root.style.setProperty('--content-h', contentH + 'px');

        const DEFAULT_CHARS = [
            "character/Gemini_Generated_Image_3x0vqz3x0vqz3x0v.png",
            "character/Gemini_Generated_Image_4uls0l4uls0l4uls.png",
            "character/Gemini_Generated_Image_8qhruu8qhruu8qhr.png",
            "character/Gemini_Generated_Image_bbdxj2bbdxj2bbdx.png",
            "character/Gemini_Generated_Image_ff9o3bff9o3bff9o.png",
            "character/Gemini_Generated_Image_fylmi8fylmi8fylm.png",
            "character/Gemini_Generated_Image_ge2lclge2lclge2l.png",
            "character/Gemini_Generated_Image_je1w43je1w43je1w.png",
            "character/Gemini_Generated_Image_nuxpt7nuxpt7nuxp.png",
            "character/Gemini_Generated_Image_svegphsvegphsveg.png",
            "character/Gemini_Generated_Image_tfcrmvtfcrmvtfrc.png",
            "character/Gemini_Generated_Image_u6h6pcu6h6pcu6h6.png",
            "character/Gemini_Generated_Image_uhtdwquhtdwquhtd.png"
        ];

        const styleConfigs = [
            { id: 'minimal', name: 'Ê•µÁ∞°', icon: 'monitor' },
            { id: 'poster', name: 'ÁÑ¶Èªû', icon: 'megaphone' },
            { id: 'memo', name: 'Á≠ÜË®ò', icon: 'file-text' },
            { id: 'journal', name: 'ÊâãË≥¨', icon: 'scissors' },
            { id: 'glass', name: 'ÁéªÁíÉ', icon: 'droplet' },
            { id: 'cyber', name: 'ÂÖâÊÑü', icon: 'sun' },
            { id: 'luxury', name: 'ÈõúË™å', icon: 'book' },
            { id: 'pop', name: 'ÊíûËâ≤', icon: 'zap' },
            { id: 'dry', name: 'Âç°Áâá', icon: 'credit-card' },
            { id: 'paper', name: 'Á¥ôË≥™', icon: 'newspaper' },
            { id: 'solid', name: 'Á¥îËâ≤', icon: 'layout' },
            { id: 'brutal', name: 'Á∑öÊ°Ü', icon: 'box' },
            { id: 'retro', name: 'ËÜ†Áâá', icon: 'camera' },
            { id: 'dark', name: 'Â§úÈñì', icon: 'moon' },
            { id: 'comic', name: 'Â°óÈ¥â', icon: 'smile' },
            { id: 'elegant', name: 'Á¥îÊ∑®', icon: 'feather' },
            { id: 'playful', name: 'ÊüîÂíå', icon: 'heart' },
            { id: 'tech', name: 'Áèæ‰ª£', icon: 'cpu' },
            { id: 'ink', name: 'Á¶™ÊÑè', icon: 'pen-tool' },
            { id: 'boxy', name: 'ÊñπÂ°ä', icon: 'grid' },
            { id: 'frame', name: 'Â§ñÊ°Ü', icon: 'square' }
        ];

        const themes = ["#f43f5e", "#3b82f6", "#10b981", "#f59e0b", "#000000"];

        const state = {
            mode: 'gen',
            title: "2024Âπ¥ÂøÖÈ†àÊéåÊè°ÁöÑ\nÂâçÁ´ØË¶ñË¶∫ÈñãÁôºÊäÄÂ∑ß",
            author: "@VisualCloneLab",
            content: `## 1. ÊéåÊè°Ëâ≤ÂΩ©ÂøÉÁêÜÂ≠∏\nËâ≤ÂΩ©‰∏çÂÉÖÊòØË£ùÈ£æÔºåÂÆÉËÉΩÁõ¥Êé•ÂΩ±ÈüøÁî®Êà∂ÁöÑÊÉÖÁ∑í„ÄÇ**ÊöñËâ≤Ë™ø**ÂÇ≥ÈÅûÊ¥ªÂäõÔºå*ÂÜ∑Ëâ≤Ë™ø*ÂÇ≥ÈÅûÂ∞àÊ•≠„ÄÇ\n\n## 2. ÁïôÁôΩÁöÑËóùË°ì\n> ÁïôÁôΩ‰∏çÊòØÁ©∫ÔºåËÄåÊòØË®≠Ë®àÁöÑÂëºÂê∏„ÄÇ\n\n‰∏çË¶ÅÂ°´ÊªøÊØè‰∏ÄÂÄãËßíËêΩ„ÄÇÈÅ©Áï∂ÁöÑÁïôÁôΩËÉΩËÆìË®≠Ë®àÂëºÂê∏ÔºåÂºïÂ∞éË¶ñÁ∑öËÅöÁÑ¶Ê†∏ÂøÉÂÖßÂÆπ„ÄÇ\n\n## 3. ÈóúÈçµÊ∏ÖÂñÆ\n- Â≠óÈ´îÂ±§Á¥öÈóú‰øÇ\n- ÂæÆ‰∫§‰∫íÂãïÁï´\n- ÈüøÊáâÂºèÊÄùÁ∂≠`,
            footerMode: 'pagenum',
            adText: "ÈªûËÆö + Êî∂Ëóè ‚ú®",
            theme: "#f43f5e",
            style: "minimal",
            useDefaultBg: false,
            uploadedBaseImg: null,
            selectedCardIndex: 0,
            cardIcons: {},
            useDefaultBgMerger: false,
            mergeBg: null,
            mergeOverlays: [],
            currentMergeIndex: 0,
            previewScale: 0.35
        };

        let dragTarget = null, startX, startY, initialLeft, initialTop;

        function init() {
            lucide.createIcons();

            const sBox = document.getElementById('style-selector');
            styleConfigs.forEach(s => {
                const btn = document.createElement('button');
                btn.id = `btn-${s.id}`;
                btn.className = `p-2 border rounded-lg flex flex-col items-center gap-1 transition-all ${state.style === s.id ? 'border-rose-500 bg-rose-50 ring-1 ring-rose-200' : 'border-slate-200 hover:bg-slate-50'}`;
                btn.innerHTML = `<i data-lucide="${s.icon}" size="14" class="${state.style === s.id ? 'text-rose-500' : 'text-slate-400'}"></i><span class="text-[10px] font-bold whitespace-nowrap text-slate-600">${s.name}</span>`;
                btn.onclick = () => switchStyle(s.id);
                sBox.appendChild(btn);
            });

            const tBox = document.getElementById('theme-box');
            themes.forEach(c => {
                const b = document.createElement('button');
                b.className = `w-8 h-8 rounded-full border-2 border-white shadow-sm shrink-0 transition-transform active:scale-90 ${state.theme === c ? 'ring-2 ring-slate-400' : ''}`;
                b.style.backgroundColor = c;
                b.onclick = () => { state.theme = c; renderGen(); };
                tBox.appendChild(b);
            });

            const cGrid = document.getElementById('default-chars');
            DEFAULT_CHARS.forEach(src => {
                const div = document.createElement('div');
                div.className = 'char-item';
                div.innerHTML = `<img src="${src}">`;
                div.onclick = () => addIconToSelectedCard(src);
                cGrid.appendChild(div);
            });

            bindInput('in-title', 'title');
            bindInput('in-author', 'author');
            bindInput('in-content', 'content');
            bindInput('in-ad', 'adText');

            const adInput = document.getElementById('in-ad');
            document.querySelector(`input[name="footer-mode"][value="${state.footerMode}"]`).checked = true;
            if (state.footerMode === 'text') adInput.classList.remove('hidden');

            document.getElementsByName('footer-mode').forEach(r => {
                r.addEventListener('change', (e) => {
                    state.footerMode = e.target.value;
                    if (state.footerMode === 'text') {
                        adInput.classList.remove('hidden');
                        adInput.value = state.adText;
                    } else {
                        adInput.classList.add('hidden');
                    }
                    renderGen();
                });
            });

            document.getElementById('check-default-bg').onchange = (e) => { state.useDefaultBg = e.target.checked; renderGen(); };
            document.getElementById('check-merger-default-bg').onchange = (e) => { state.useDefaultBgMerger = e.target.checked; renderMerger(); };

            window.addEventListener('mousemove', onGlobalMouseMove);
            window.addEventListener('mouseup', onGlobalMouseUp);
            window.addEventListener('touchmove', (e) => onGlobalMouseMove(e), { passive: false });
            window.addEventListener('touchend', onGlobalMouseUp);
            window.addEventListener('resize', () => { adjustScale(); renderGen(); });

            adjustScale();
            renderGen();
        }

        function bindInput(id, key) {
            const el = document.getElementById(id);
            el.value = state[key];
            el.oninput = (e) => { state[key] = e.target.value; renderGen(); };
        }

        function switchMode(mode) {
            state.mode = mode;
            document.getElementById('nav-gen').classList.toggle('active', mode === 'gen');
            document.getElementById('nav-merge').classList.toggle('active', mode === 'merge');
            document.getElementById('sidebar-gen').classList.toggle('hidden', mode !== 'gen');
            document.getElementById('sidebar-merge').classList.toggle('hidden', mode !== 'merge');
            document.getElementById('canvas-wrapper').classList.toggle('hidden', mode !== 'gen');
            document.getElementById('merger-wrapper').classList.toggle('hidden', mode !== 'merge');

            const btnSpan = document.querySelector('#export-btn span');
            if (mode === 'gen') btnSpan.innerText = '‰∏ãËºâ';
            else btnSpan.innerText = (state.mergeOverlays.length > 1) ? 'ÊâπÈáè‰∏ãËºâ' : '‰∏ãËºâ';

            adjustScale();
            if (mode === 'merge') renderMerger();
        }

        function switchStyle(id) {
            state.style = id;
            styleConfigs.forEach(s => {
                const b = document.getElementById(`btn-${s.id}`);
                const isActive = s.id === id;
                b.className = `p-2 border rounded-lg flex flex-col items-center gap-1 transition-all ${isActive ? 'border-rose-500 bg-rose-50 ring-1 ring-rose-200' : 'border-slate-200 hover:bg-slate-50'}`;
                const icon = b.querySelector('i') || b.querySelector('svg');
                if (icon) {
                    icon.classList.remove('text-rose-500', 'text-slate-400');
                    icon.classList.add(isActive ? 'text-rose-500' : 'text-slate-400');
                }
            });
            renderGen();
        }

        function adjustScale() {
            const wrap = document.getElementById('preview-section');
            if (!wrap) return;
            const availableWidth = wrap.clientWidth;
            let scale = (availableWidth - 32) / APP_CONFIG.width;
            if (scale > 0.35) scale = 0.35;
            if (scale < 0.15) scale = 0.15;
            state.previewScale = scale;
            document.documentElement.style.setProperty('--preview-scale', state.previewScale);
        }

        function selectCard(index) { state.selectedCardIndex = index; renderGen(); }

        function addIconToSelectedCard(src) {
            if (!state.cardIcons[state.selectedCardIndex]) state.cardIcons[state.selectedCardIndex] = [];
            if (state.cardIcons[state.selectedCardIndex].length >= 5) { alert("ÊúÄÂ§ö 5 ÂÄãË≤ºÁ¥ô"); return; }
            state.cardIcons[state.selectedCardIndex].push({ id: Date.now(), src: src, x: 800, y: 1000 });
            renderGen();
        }

        function handleImgUpload(e, type) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                if (type === 'base') state.uploadedBaseImg = ev.target.result;
                else if (type === 'ip') addIconToSelectedCard(ev.target.result);
                renderGen();
            };
            reader.readAsDataURL(file);
        }

        function handleMergerUpload(e, type) {
            const files = e.target.files;
            if (!files.length) return;

            if (type === 'bg') {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    state.mergeBg = ev.target.result;
                    renderMerger();
                };
                reader.readAsDataURL(files[0]);
            } else if (type === 'overlay') {
                const promises = Array.from(files).map(file => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (ev) => resolve(ev.target.result);
                        reader.readAsDataURL(file);
                    });
                });

                Promise.all(promises).then(results => {
                    state.mergeOverlays = results;
                    state.currentMergeIndex = 0;
                    renderMerger();
                    if (state.mode === 'merge') {
                        document.querySelector('#export-btn span').innerText = (results.length > 1) ? 'ÊâπÈáè‰∏ãËºâ' : '‰∏ãËºâ';
                    }
                });
            }
        }

        function changeMergeSlide(dir) {
            const newIndex = state.currentMergeIndex + dir;
            if (newIndex >= 0 && newIndex < state.mergeOverlays.length) {
                state.currentMergeIndex = newIndex;
                renderMerger();
            }
        }

        // --- ÈóúÈçµÊõ¥Êñ∞Ôºö‰ΩøÁî®ÊÇ®Êèê‰æõÁöÑ renderMerger ÈÇèËºØ ---
        function renderMerger() {
            const bgEl = document.getElementById('merge-bg-el');
            const overEl = document.getElementById('merge-overlay-el');
            const prevBtn = document.getElementById('merge-prev');
            const nextBtn = document.getElementById('merge-next');
            const title = document.getElementById('preview-title');

            // ===== ËÉåÊôØËôïÁêÜ =====
            if (state.mergeBg) {
                bgEl.style.backgroundImage = `url(${state.mergeBg})`;
                bgEl.style.backgroundSize = 'cover';
                bgEl.style.backgroundRepeat = 'no-repeat';
                bgEl.style.backgroundColor = 'transparent';
                bgEl.classList.remove('hidden');
            }
            else if (state.useDefaultBgMerger) {
                bgEl.style.backgroundImage = `url('${APP_CONFIG.bgUrl}')`;
                bgEl.style.backgroundSize = 'repeat'; // pattern
                bgEl.style.backgroundRepeat = 'repeat';
                bgEl.style.backgroundColor = '#f8fafc';
                bgEl.classList.remove('hidden');
            }
            else {
                bgEl.style.backgroundImage = '';
                bgEl.style.backgroundColor = '#ffffff';
                bgEl.classList.remove('hidden');
            }

            // ===== Overlay ËôïÁêÜ =====
            if (state.mergeOverlays.length > 0) {
                overEl.src = state.mergeOverlays[state.currentMergeIndex];
                overEl.classList.remove('hidden');

                // Êõ¥Êñ∞Ê®ôÈ°åÈ°ØÁ§∫È†ÅÊï∏
                title.innerText = `È†êË¶Ω ${state.currentMergeIndex + 1} / ${state.mergeOverlays.length}`;

                // Â∑¶Âè≥ÊåâÈàïÊéßÂà∂
                if (state.mergeOverlays.length > 1) {
                    prevBtn.classList.remove('hidden');
                    nextBtn.classList.remove('hidden');

                    prevBtn.classList.toggle('disabled', state.currentMergeIndex === 0);
                    nextBtn.classList.toggle('disabled', state.currentMergeIndex === state.mergeOverlays.length - 1);
                } else {
                    prevBtn.classList.add('hidden');
                    nextBtn.classList.add('hidden');
                }
            } else {
                overEl.src = '';
                overEl.classList.add('hidden');
                prevBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
                title.innerText = 'È†êË¶ΩÂçÄ';
            }
        }

        function calculatePages(rawText) {
            const pages = []; let currentSet = []; let currentH = 0;
            const maxH = APP_CONFIG.height - APP_CONFIG.headerHeight - APP_CONFIG.footerHeight - APP_CONFIG.contentPadding * 2;

            const fullHtml = marked.parse(rawText);
            const tempDiv = document.createElement('div'); tempDiv.innerHTML = fullHtml;
            const nodes = Array.from(tempDiv.children);
            const m = document.getElementById('measurer');
            m.className = `style-${state.style} md-content`;
            if (['journal', 'playful', 'comic'].includes(state.style)) { m.style.fontFamily = 'Zen Maru Gothic, sans-serif'; }
            else if (['luxury', 'paper', 'ink', 'retro', 'frame'].includes(state.style)) { m.style.fontFamily = 'Noto Serif TC, serif'; }
            else { m.style.fontFamily = 'Noto Sans TC, sans-serif'; }

            nodes.forEach(node => {
                m.innerHTML = ''; m.appendChild(node.cloneNode(true));
                const h = m.offsetHeight + 24;
                if (currentH + h > maxH && currentSet.length > 0) {
                    pages.push(currentSet); currentSet = [node.outerHTML]; currentH = h;
                } else {
                    currentSet.push(node.outerHTML); currentH += h;
                }
            });
            if (currentSet.length > 0) pages.push(currentSet);
            if (pages.length === 0 && rawText.trim().length > 0) return [[marked.parse(rawText)]];
            else if (pages.length === 0) return [[]];
            return pages;
        }

        function getBackgroundStyle() {
            if (state.uploadedBaseImg) return `url(${state.uploadedBaseImg})`;
            if (state.useDefaultBg) return `url('${APP_CONFIG.bgUrl}')`;
            return 'none';
        }

        function renderGen() {
            const wrapper = document.getElementById('canvas-wrapper');
            wrapper.innerHTML = '';
            const pages = calculatePages(state.content);
            if (state.selectedCardIndex >= pages.length + 1) state.selectedCardIndex = 0;

            const coverWrapper = document.createElement('div');
            coverWrapper.className = `card-wrapper ${state.selectedCardIndex === 0 ? 'selected' : ''}`;
            coverWrapper.onclick = () => selectCard(0);
            wrapper.appendChild(coverWrapper);
            coverWrapper.appendChild(createCard(0, 1, pages.length + 1, [], true));

            pages.forEach((items, i) => {
                const idx = i + 1;
                const cw = document.createElement('div');
                cw.className = `card-wrapper ${state.selectedCardIndex === idx ? 'selected' : ''}`;
                cw.onclick = () => selectCard(idx);
                wrapper.appendChild(cw);
                cw.appendChild(createCard(idx, idx + 1, pages.length + 1, items, false));
            });
            lucide.createIcons();
        }

        function createCard(pageIndex, num, total, htmlItems, isCover) {
            const card = document.createElement('div');
            card.className = `card-container style-${state.style}`;
            card.style.setProperty('--theme', state.theme);

            card.style.backgroundImage = getBackgroundStyle();
            card.style.backgroundSize = 'cover';
            if (state.useDefaultBg && !state.uploadedBaseImg) {
                card.style.backgroundSize = 'repeat';
                card.style.backgroundColor = '#f0f0f0';
            } else if (!state.uploadedBaseImg) {
                card.style.backgroundColor = '#ffffff';
            }

            const footer = document.createElement('div');
            footer.className = 'area-footer';
            let fc = '';
            if (state.footerMode === 'text') fc = `<div class="footer-pill text-sm">${state.adText}</div>`;
            else if (state.footerMode === 'pagenum') fc = `<div class="footer-simple">${num} / ${total}</div>`;
            footer.innerHTML = fc;

            let bodyHtml = isCover ? renderCover() : renderContent(htmlItems);
            if (state.style === 'frame') bodyHtml = `<div class="frame-border">${bodyHtml}</div>`;

            const iconsHtml = (state.cardIcons[pageIndex] || []).map((icon, idx) => `
                <div class="draggable-ip" style="left:${icon.x}px; top:${icon.y}px;" data-card-index="${pageIndex}" data-icon-index="${idx}" onmousedown="onIpStart(event)" ontouchstart="onIpStart(event)">
                    <img src="${icon.src}" class="w-full pointer-events-none">
                    <button class="absolute -top-3 -right-3 bg-red-500 text-white rounded-full p-1 shadow-md" onclick="removeIcon(event, ${pageIndex}, ${idx})"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                </div>`).join('');

            card.innerHTML = `<div class="area-header"></div><div class="area-content md-content">${bodyHtml}</div><div class="ip-layer">${iconsHtml}</div>`;
            card.appendChild(footer);
            return card;
        }

        function removeIcon(e, cIdx, iIdx) { e.stopPropagation(); state.cardIcons[cIdx].splice(iIdx, 1); renderGen(); }

        // --- Render Templates ---
        function renderCover() {
            const t = state.title.replace(/\n/g, '<br>');
            const a = state.author;
            if (state.style === 'poster') {
                return `<div class="h-full flex flex-col justify-center items-center text-center p-12"><div class="poster-box"><h1 class="text-[90px] font-black leading-none mb-10">${t}</h1><div class="w-full h-1 bg-white/30 mb-8"></div><p class="text-3xl font-bold tracking-widest uppercase">${a}</p></div></div>`;
            }
            return `<div class="h-full flex flex-col justify-center items-start p-10"><div class="min-line"></div><h1 class="text-[90px] font-black leading-tight text-slate-800 mb-8">${t}</h1><p class="text-3xl text-slate-500 font-medium">@${a}</p></div>`;
        }

        function renderContent(items) {
            const c = items.join('');
            if (state.style === 'poster') return `<div class="poster-box">${c}</div>`;
            return `<div>${c}</div>`;
        }

        function onIpStart(e) { if (e.target.closest('button')) return; dragTarget = e.currentTarget; startX = (e.touches ? e.touches[0] : e).clientX; startY = (e.touches ? e.touches[0] : e).clientY; initialLeft = parseFloat(dragTarget.style.left) || 0; initialTop = parseFloat(dragTarget.style.top) || 0; dragTarget.style.cursor = 'grabbing'; dragTarget.style.zIndex = 1000; e.stopPropagation(); if (e.cancelable) e.preventDefault(); }
        function onGlobalMouseMove(e) { if (!dragTarget) return; const evt = e.touches ? e.touches[0] : e; dragTarget.style.left = (initialLeft + (evt.clientX - startX) / state.previewScale) + 'px'; dragTarget.style.top = (initialTop + (evt.clientY - startY) / state.previewScale) + 'px'; }
        function onGlobalMouseUp() { if (!dragTarget) return; const c = parseInt(dragTarget.getAttribute('data-card-index')), i = parseInt(dragTarget.getAttribute('data-icon-index')); if (state.cardIcons[c]?.[i]) { state.cardIcons[c][i].x = parseFloat(dragTarget.style.left); state.cardIcons[c][i].y = parseFloat(dragTarget.style.top); } dragTarget.style.cursor = 'grab'; dragTarget.style.zIndex = ''; dragTarget = null; }

        function handleExport() { state.mode === 'gen' ? downloadZip() : downloadMerger(); }

        async function downloadMerger() {
            const overlay = document.getElementById('export-overlay');
            const progress = document.getElementById('progress-val');
            const cardEl = document.getElementById('merger-card');
            const overlayEl = document.getElementById('merge-overlay-el');

            overlay.style.display = 'flex';

            try {
                if (state.mergeOverlays.length <= 1) {
                    const c = await html2canvas(cardEl, {
                        scale: 1, width: APP_CONFIG.width, height: APP_CONFIG.height, useCORS: true, backgroundColor: '#ffffff'
                    });
                    const a = document.createElement('a');
                    a.download = `Merger_${Date.now()}.png`;
                    a.href = c.toDataURL();
                    a.click();
                }
                else {
                    const zip = new JSZip();
                    const originalIndex = state.currentMergeIndex;

                    for (let i = 0; i < state.mergeOverlays.length; i++) {
                        progress.innerText = `Processing ${i + 1} / ${state.mergeOverlays.length}`;
                        state.currentMergeIndex = i;
                        overlayEl.src = state.mergeOverlays[i];
                        await new Promise(resolve => {
                            if (overlayEl.complete) resolve();
                            else overlayEl.onload = resolve;
                        });
                        await new Promise(r => setTimeout(r, 50));
                        const canvas = await html2canvas(cardEl, {
                            scale: 1, width: APP_CONFIG.width, height: APP_CONFIG.height, useCORS: true, backgroundColor: '#ffffff'
                        });
                        const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
                        zip.file(`Merger_${i + 1}.png`, blob);
                    }
                    state.currentMergeIndex = originalIndex;
                    overlayEl.src = state.mergeOverlays[originalIndex];
                    progress.innerText = "Compressing...";
                    const content = await zip.generateAsync({ type: "blob" });
                    saveAs(content, `Batch_Merger_${Date.now()}.zip`);
                }
            } catch (e) {
                console.error(e);
                alert('Error generating image');
            } finally {
                overlay.style.display = 'none';
            }
        }

        async function downloadZip() {
            const overlay = document.getElementById('export-overlay');
            const progress = document.getElementById('progress-val');
            overlay.style.display = 'flex';
            await new Promise(r => setTimeout(r, 100));
            const zip = new JSZip();
            const cards = document.querySelectorAll('.card-wrapper');

            for (let i = 0; i < cards.length; i++) {
                if (cards[i].closest('#merger-wrapper')) continue;

                progress.innerText = `Card ${i + 1}`;
                const el = cards[i].querySelector('.card-container').cloneNode(true);
                el.style.transform = 'none'; el.style.position = 'fixed'; el.style.top = '0'; el.style.left = '-9999px';
                el.style.width = APP_CONFIG.width + 'px';
                el.style.height = APP_CONFIG.height + 'px';
                el.querySelectorAll('button').forEach(b => b.remove());

                let bg = '#ffffff';
                if (['poster'].includes(state.style)) bg = '#FCD34D';

                if (state.useDefaultBg && !state.uploadedBaseImg) {
                    el.style.backgroundImage = `url('${APP_CONFIG.bgUrl}')`;
                    el.style.backgroundSize = 'repeat';
                }

                el.style.backgroundColor = bg;
                document.body.appendChild(el);

                const c = await html2canvas(el, { scale: 1, width: APP_CONFIG.width, height: APP_CONFIG.height, useCORS: true, backgroundColor: bg });
                document.body.removeChild(el);
                zip.file(`${i + 1}.png`, await new Promise(r => c.toBlob(r)));
            }
            saveAs(await zip.generateAsync({ type: 'blob' }), `VisualClone_${Date.now()}.zip`);
            overlay.style.display = 'none';
        }
        window.onload = init;
    </script>
</body>

</html>