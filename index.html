<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Clone Pro - 爆款卡片生成器</title>
    
    <!-- 核心庫引用 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+SC:wght@300;400;700;900&family=Noto+Serif+SC:wght@400;700&family=ZCOOL+KuaiLe&display=swap');
        
        :root {
            --canvas-w: 1080px;
            --canvas-h: 1350px;
            --header-h: 120px;
            --footer-h: 60px;
            --content-h: 1170px;
            --preview-scale: 0.35; 
        }

        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background-color: #f1f5f9;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* 畫布基礎樣式 */
        .card-container {
            width: var(--canvas-w);
            height: var(--canvas-h);
            background-color: white;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            box-shadow: 0 30px 60px rgba(0,0,0,0.12);
            transform: scale(var(--preview-scale));
            transform-origin: top center;
            margin-bottom: calc(var(--canvas-h) * (var(--preview-scale) - 1) + 30px);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* 區域定位 */
        .area-header { position: absolute; top: 0; left: 0; width: 100%; height: var(--header-h); z-index: 100; pointer-events: none; }
        .area-footer { position: absolute; bottom: 0; left: 0; width: 100%; height: var(--footer-h); z-index: 100; pointer-events: none; display: flex; align-items: center; justify-content: center; }
        .area-content { position: absolute; top: var(--header-h); left: 0; width: 100%; height: var(--content-h); padding: 60px 80px; box-sizing: border-box; z-index: 10; overflow: hidden; }

        /* --- 款式風格 CSS --- */
        
        /* 1. 簡約風 */
        .style-minimal { font-family: 'Noto Serif SC', serif; background-color: #fdfdfd; color: #333; }
        .style-minimal .accent-line { width: 80px; height: 4px; background: #333; margin: 40px 0; }
        
        /* 2. 大字報 */
        .style-poster { font-family: 'Noto Sans SC', sans-serif; background-color: #FFD700; color: #000; }
        .style-poster .big-title { font-weight: 900; line-height: 1.1; text-transform: uppercase; border: 8px solid #000; padding: 25px; background: #fff; box-shadow: 15px 15px 0px #000; color: #000; }
        .style-poster .content-box { background: #fff; border: 4px solid #000; padding: 30px; box-shadow: 10px 10px 0px #000; color: #000; }

        /* 3. 備忘錄 */
        .style-memo { font-family: 'Courier New', Courier, monospace; background-color: #fff9c4; color: #4a4a4a; background-image: linear-gradient(#e1e1e1 2px, transparent 2px); background-size: 100% 3rem; }
        .style-memo .tape { width: 200px; height: 60px; background: rgba(254, 240, 138, 0.7); transform: rotate(-3deg); position: absolute; top: -30px; left: 50%; margin-left: -100px; z-index: 5; }
        
        /* 4. 手賬風 */
        .style-journal { font-family: 'ZCOOL KuaiLe', cursive; background-color: #FFF0F5; color: #5D4037; background-image: radial-gradient(#FFB6C1 2px, transparent 2px); background-size: 40px 40px; }
        .style-journal .journal-card { border: 6px dashed #f9a8d4; border-radius: 60px; background: rgba(255,255,255,0.85); padding: 40px; }
        
        /* 5. 干貨風 */
        .style-dry { font-family: 'Noto Sans SC', sans-serif; background-color: #1e293b; color: #f8fafc; }
        .style-dry .glass-card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(15px); border: 2px solid rgba(255,255,255,0.2); border-radius: 30px; padding: 40px; }
        .style-dry .num-badge { background: #38bdf8; color: #0f172a; font-weight: 900; border-radius: 50%; width: 50px; height: 50px; display: inline-flex; align-items: center; justify-content: center; margin-right: 20px; font-size: 28px; }

        /* IP 角色圖層 */
        .ip-layer { position: absolute; inset: 0; z-index: 200; pointer-events: none; background: transparent; }
        .draggable-ip { 
            position: absolute; 
            width: 320px; 
            height: auto; 
            cursor: grab; 
            pointer-events: auto; 
            user-select: none;
            will-change: transform;
        }
        .draggable-ip:active { cursor: grabbing; }

        /* Footer 毛玻璃樣式 */
        .footer-content-blur { background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 10px 50px; border-radius: 100px; border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

        #export-overlay { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.95); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; color: white; }
    </style>
</head>
<body class="flex flex-col">

    <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 z-50">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-rose-500 rounded-lg flex items-center justify-center text-white shadow-sm shadow-rose-200">
                <i data-lucide="camera" size="18"></i>
            </div>
            <h1 class="text-xl font-bold tracking-tight text-slate-800">Visual Clone <span class="text-rose-500">Engine Pro</span></h1>
        </div>
        <button onclick="downloadAll()" class="bg-rose-500 hover:bg-rose-600 text-white px-6 py-2 rounded-full font-bold flex items-center gap-2 transition-all shadow-lg shadow-rose-200 active:scale-95">
            <i data-lucide="download" size="18"></i> 打包導出高清 ZIP
        </button>
    </header>

    <main class="flex flex-1 overflow-hidden">
        <!-- 側邊欄編輯器 -->
        <aside class="w-[420px] bg-white border-r border-slate-200 flex flex-col sidebar-scroll overflow-y-auto">
            <div class="p-6 space-y-8">
                
                <!-- 1. 款式切換 -->
                <section class="space-y-4">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">1. 款式切換 (Styles)</h3>
                    <div class="grid grid-cols-3 gap-2" id="style-selector"></div>
                </section>

                <!-- 2. 資產上傳 -->
                <section class="space-y-4">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">2. 視覺資產上傳</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <label class="border-2 border-dashed border-slate-200 rounded-xl h-24 flex flex-col items-center justify-center cursor-pointer hover:bg-rose-50 transition-all">
                            <i data-lucide="image" class="text-slate-400 mb-1"></i>
                            <span class="text-[10px] text-slate-500 font-bold">上傳底圖 (Frame)</span>
                            <input type="file" class="hidden" accept="image/*" onchange="handleImgUpload(event, 'base')">
                        </label>
                        <label class="border-2 border-dashed border-slate-200 rounded-xl h-24 flex flex-col items-center justify-center cursor-pointer hover:bg-rose-50 transition-all">
                            <i data-lucide="smile" class="text-slate-400 mb-1"></i>
                            <span class="text-[10px] text-slate-500 font-bold">上傳角色 (PNG)</span>
                            <input type="file" class="hidden" accept="image/*" onchange="handleImgUpload(event, 'ip')">
                        </label>
                    </div>
                </section>

                <!-- 3. 內容編輯 -->
                <section class="space-y-4">
                    <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest">3. 內容動態編輯</h3>
                    <div class="space-y-4">
                        <input type="text" id="in-title" class="w-full border border-slate-200 rounded-lg p-3 font-bold focus:ring-2 focus:ring-rose-500 outline-none" placeholder="封面大標題">
                        <input type="text" id="in-author" class="w-full border border-slate-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-rose-500 outline-none" placeholder="署名 / 帳號">
                        <textarea id="in-content" rows="10" class="w-full border border-slate-200 rounded-lg p-3 text-sm leading-relaxed focus:ring-2 focus:ring-rose-500 outline-none resize-none" placeholder="正文內容"></textarea>
                        
                        <div class="space-y-3">
                             <input type="text" id="in-ad" class="w-full border border-slate-200 rounded-lg p-3 text-sm italic focus:ring-2 focus:ring-rose-500 outline-none" placeholder="底部推廣語">
                             <div class="flex items-center gap-2 px-1">
                                <input type="checkbox" id="check-pagenum" class="w-4 h-4 rounded border-slate-300 text-rose-600 focus:ring-rose-500 cursor-pointer">
                                <label for="check-pagenum" class="text-xs font-bold text-slate-600 cursor-pointer">顯示頁數</label>
                             </div>
                        </div>
                    </div>
                </section>

                <!-- 4. 品牌色 -->
                <section class="space-y-4">
                    <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest">4. 視覺主色 (Theme Color)</h3>
                    <div id="theme-box" class="flex gap-3"></div>
                </section>
            </div>
        </aside>

        <!-- 畫布預覽區 -->
        <section class="flex-1 overflow-y-auto p-12 bg-slate-50 flex flex-col items-center custom-scroll" id="preview-section">
            <div class="mb-8 flex items-center gap-4 text-slate-400 bg-white px-6 py-2 rounded-full shadow-sm">
                <i data-lucide="eye" size="18"></i>
                <span class="text-sm font-bold uppercase tracking-tighter">HD Preview • 1080 x 1350 • 款式：<span id="current-style-name">簡約風</span></span>
            </div>
            <div id="canvas-wrapper" class="flex flex-col items-center"></div>
        </section>
    </main>

    <!-- 導出遮罩 -->
    <div id="export-overlay">
        <div class="animate-spin text-rose-400 mb-6"><i data-lucide="refresh-cw" size="64"></i></div>
        <h2 class="text-3xl font-black mb-2 tracking-tighter uppercase">Generative HD Assets</h2>
        <p class="text-slate-400 font-mono" id="progress-val">0 / 0</p>
    </div>

    <!-- 隱藏測量器 -->
    <div id="measurer" style="position:absolute; visibility:hidden; width:920px; font-size:40px; line-height:1.6;"></div>

    <script>
        const state = {
            title: "2024年必須掌握的\n前端視覺開發技巧",
            author: "@VisualCloneLab",
            content: `1. 掌握色彩心理學\n色彩不僅是裝飾，它能直接影響用戶的情緒。暖色調傳遞活力，冷色調傳遞專業。\n\n2. 留白的藝術\n不要填滿每一個角落。適當的留白能讓設計呼吸，引導視線聚焦核心內容。\n\n3. 字體層級關係\n通過字號、字重、顏色深淺建立清晰的信息層級。標題要大，正文要易讀。\n\n4. 微交互動畫\n添加細微的 Hover 效果或點擊回饋，能極大提升產品的精緻感和用戶體驗。\n\n5. 響應式思維\n設計不應只針對單一螢幕。思考內容在不同尺寸下如何流佈局，是現代前端的基礎。`,
            adText: "點讚 + 收藏，獲取更多源碼資源 ✨",
            showPageNum: true,
            theme: "#f43f5e",
            style: "minimal",
            baseImg: null,
            ipImg: null,
            previewScale: 0.35
        };

        const styleConfigs = [
            { id: 'minimal', name: '簡約風', icon: 'monitor' },
            { id: 'poster', name: '大字報', icon: 'megaphone' },
            { id: 'memo', name: '備忘錄', icon: 'file-text' },
            { id: 'journal', name: '手賬風', icon: 'scissors' },
            { id: 'dry', name: '乾貨風', icon: 'book-open' }
        ];

        const themes = ["#f43f5e", "#3b82f6", "#10b981", "#f59e0b", "#000000"];

        // 拖拽全域狀態
        let dragTarget = null;
        let startX, startY, initialX, initialY;
        let isMoving = false;

        function init() {
            lucide.createIcons();
            
            // 初始化款式
            const sBox = document.getElementById('style-selector');
            styleConfigs.forEach(s => {
                const btn = document.createElement('button');
                btn.id = `btn-${s.id}`;
                btn.className = `p-3 border rounded-xl flex flex-col items-center gap-1 transition-all ${state.style === s.id ? 'border-rose-500 bg-rose-50 ring-2 ring-rose-200' : 'border-slate-200 hover:bg-slate-50'}`;
                btn.innerHTML = `<i data-lucide="${s.icon}" size="18" class="${state.style === s.id ? 'text-rose-500' : 'text-slate-400'}"></i><span class="text-[10px] font-bold">${s.name}</span>`;
                btn.onclick = () => switchStyle(s.id);
                sBox.appendChild(btn);
            });

            // 初始化顏色
            const tBox = document.getElementById('theme-box');
            themes.forEach(c => {
                const b = document.createElement('button');
                b.className = `w-10 h-10 rounded-full border-2 border-white shadow-sm transition-transform active:scale-90 ${state.theme === c ? 'ring-2 ring-slate-400' : ''}`;
                b.style.backgroundColor = c;
                b.onclick = () => { state.theme = c; render(); };
                tBox.appendChild(b);
            });

            // 綁定輸入
            ['in-title', 'in-author', 'in-content', 'in-ad'].forEach(id => {
                const el = document.getElementById(id);
                const key = id.split('-')[1] === 'ad' ? 'adText' : id.split('-')[1];
                el.value = state[key];
                el.oninput = (e) => { state[key] = e.target.value; render(); };
            });

            const pNumCheck = document.getElementById('check-pagenum');
            pNumCheck.checked = state.showPageNum;
            pNumCheck.onchange = (e) => { state.showPageNum = e.target.checked; render(); };

            // 註冊全域拖拽
            window.addEventListener('mousemove', onGlobalMouseMove);
            window.addEventListener('mouseup', onGlobalMouseUp);
            window.addEventListener('touchmove', (e) => onGlobalMouseMove(e), { passive: false });
            window.addEventListener('touchend', onGlobalMouseUp);

            window.onresize = adjustScale;
            adjustScale();
            render();
        }

        // 強力修正切換款式：確保 UI 立即響應
        // 修正 switchStyle 函數
        function switchStyle(id) {
            state.style = id;
            document.getElementById('current-style-name').innerText = styleConfigs.find(x => x.id === id).name;
            
            // 更新按鈕樣式
            styleConfigs.forEach(s => {
                const b = document.getElementById(`btn-${s.id}`);
                const isActive = s.id === id;
                b.className = `p-3 border rounded-xl flex flex-col items-center gap-1 transition-all ${isActive ? 'border-rose-500 bg-rose-50 ring-2 ring-rose-200' : 'border-slate-200 hover:bg-slate-50'}`;
                const icon = b.querySelector('i');
                if (icon) icon.className = `${isActive ? 'text-rose-500' : 'text-slate-400'}`;
            });

            // 立即強制重新渲染
            render();
            
            // 重新創建圖標
            setTimeout(() => lucide.createIcons(), 10);
        }

        function adjustScale() {
            const wrap = document.getElementById('preview-section');
            state.previewScale = Math.min(0.4, (wrap.clientWidth - 100) / 1080);
            document.documentElement.style.setProperty('--preview-scale', state.previewScale);
        }

        function handleImgUpload(e, type) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                if (type === 'base') state.baseImg = ev.target.result;
                if (type === 'ip') state.ipImg = ev.target.result;
                render();
            };
            reader.readAsDataURL(file);
        }

        function calculatePages(paras) {
            const pages = [[]]; 
            let currentSet = [];
            let currentH = 0;
            const maxH = 920;
            const m = document.getElementById('measurer');
            
            // 每次計算前確保款式同步
            m.className = `style-${state.style}`;
            m.style.fontFamily = (state.style === 'minimal') ? 'Noto Serif SC, serif' : 'Noto Sans SC, sans-serif';

            paras.forEach(p => {
                m.innerText = p;
                const h = m.offsetHeight + 60;
                if (currentH + h > maxH) {
                    pages.push(currentSet);
                    currentSet = [p];
                    currentH = h;
                } else {
                    currentSet.push(p);
                    currentH += h;
                }
            });
            if (currentSet.length > 0) pages.push(currentSet);
            return pages;
        }

        function render() {
            const wrapper = document.getElementById('canvas-wrapper');
            wrapper.innerHTML = '';
            const paras = state.content.split('\n').filter(p => p.trim() !== '');
            const pages = calculatePages(paras);
            pages.forEach((items, i) => wrapper.appendChild(createCard(i + 1, pages.length, items, i === 0)));
            lucide.createIcons();
        }

        function createCard(num, total, paras, isCover) {
            const card = document.createElement('div');
            card.className = `card-container style-${state.style}`;
            card.style.setProperty('--theme', state.theme);
            if (state.baseImg) card.style.backgroundImage = `url(${state.baseImg})`;

            const header = ``;
            
            const hasFooterText = state.adText && state.adText.trim() !== "";
            const footer = document.createElement('div');
            footer.className = 'area-footer';
            
            let footerInner = "";
            if (hasFooterText) {
                footerInner += `<div class="footer-content-blur"><span class="text-xl font-bold text-slate-700 tracking-wider">${state.adText}</span></div>`;
            }
            if (state.showPageNum) {
                footerInner += `<div class="absolute right-12 text-2xl font-black text-slate-400 p-2">${num} / ${total}</div>`;
            }
            footer.innerHTML = footerInner;

            let bodyHtml = isCover ? renderCover() : renderContent(paras, num);

            card.innerHTML = `
                ${header}
                <div class="area-content">${bodyHtml}</div>
                <div class="ip-layer">
                    ${state.ipImg ? `
                        <div class="draggable-ip"
                            style="right:80px; bottom:120px;"
                            onmousedown="onIpStart(event)"
                            ontouchstart="onIpStart(event)">
                            <img src="${state.ipImg}" class="w-full pointer-events-none">
                        </div>
                    ` : ''}
                </div>
            `;
            card.appendChild(footer);
            return card;
        }

        function renderCover() {
            const t = state.title.replace(/\n/g, '<br>');
            switch(state.style) {
                case 'minimal': 
                    return `<div class="h-full flex flex-col justify-between relative"><div class="absolute top-0 right-0 text-[200px] text-gray-100 font-serif opacity-50">01</div><div class="mt-40"><div class="text-3xl tracking-[10px] text-gray-400 mb-8 uppercase">Topic of the day</div><h1 class="text-[100px] font-black">${t}</h1><div class="accent-line"></div><p class="text-gray-500 mt-10 text-4xl italic">Created by ${state.author}</p></div><div class="border-t-4 border-gray-100 pt-10 flex justify-between items-end"><div class="text-3xl font-bold text-gray-400">READ MORE</div><i data-lucide="arrow-right" size="48"></i></div></div>`;
                case 'poster':
                    return `<div class="h-full flex flex-col justify-center items-center text-center"><div class="bg-black text-yellow-400 px-8 py-2 font-bold mb-10 transform -rotate-2 text-3xl uppercase">Visual Clone</div><div class="big-title text-[90px] mb-12">${t}</div><div class="bg-black text-white px-12 py-4 rounded-full font-black text-4xl mt-6">${state.author}</div></div>`;
                case 'memo':
                    return `<div class="h-full relative pt-20"><div class="absolute top-0 left-0 w-full h-16 bg-[#e0e0e0] flex items-center px-10 gap-6 border-b-4 border-gray-300"><div class="w-6 h-6 rounded-full bg-red-400"></div><div class="w-6 h-6 rounded-full bg-yellow-400"></div><div class="w-6 h-6 rounded-full bg-green-400"></div></div><div class="mt-10"><span class="bg-yellow-300 px-6 py-2 text-2xl font-bold transform -rotate-1 inline-block mb-10">MEMO SYSTEM</span><h1 class="text-[80px] font-black leading-normal border-b-4 border-dashed border-gray-400 pb-10">${t}</h1><div class="mt-12 flex items-center gap-6 text-3xl font-mono"><i data-lucide="user"></i> ${state.author}</div></div></div>`;
                case 'journal':
                    return `<div class="h-full flex flex-col justify-center items-center text-center journal-card"><div class="bg-white/90 p-16 rounded-[60px] border-4 border-dashed border-pink-200 transform rotate-1"><h1 class="text-[85px] text-gray-700 leading-relaxed mb-6">${t}</h1><div class="w-full h-2 bg-pink-200 rounded-full mb-6"></div><p class="text-pink-400 text-5xl">By ${state.author}</p></div></div>`;
                case 'dry':
                    return `<div class="h-full flex flex-col justify-center relative"><div class="absolute top-0 left-0 w-full h-4 bg-gradient-to-r from-blue-500 to-purple-500"></div><div class="glass-card mb-12 border-l-[15px] border-blue-500"><div class="text-blue-400 text-2xl font-black mb-6 uppercase">Knowledge Base</div><h1 class="text-[85px] font-black text-white">${t}</h1></div><div class="flex items-center gap-6 mt-10"><div class="w-24 h-24 rounded-full bg-slate-700 flex items-center justify-center text-white text-5xl font-black">${state.author.charAt(0).toUpperCase()}</div><div class="text-slate-400 text-3xl"><p class="text-white font-black">${state.author}</p><p class="mt-2">乾貨分享</p></div></div></div>`;
                default: return `<div class="h-full flex flex-col justify-center"><h1 class="text-[90px] font-black">${t}</h1></div>`;
            }
        }

        function renderContent(paras, num) {
            const items = paras.map((p, idx) => {
                if (state.style === 'poster') return `<div class="content-box text-5xl font-black mb-10">${p}</div>`;
                if (state.style === 'dry') return `<div class="mb-10 flex items-start gap-6"><div class="num-badge">${idx + 1}</div><div class="glass-card text-4xl leading-relaxed w-full">${p}</div></div>`;
                if (state.style === 'memo') return `<p class="mb-12 text-4xl font-bold border-b-2 border-slate-200 pb-4">${p}</p>`;
                if (state.style === 'journal') return `<div class="journal-card mb-10 text-5xl text-pink-600">${p}</div>`;
                return `<p class="mb-12 text-4xl leading-[1.6] text-justify font-medium">${p}</p>`;
            }).join('');
            return `<div class="h-full w-full">${state.style === 'memo' ? '<div class="tape"></div>' : ''}${items}</div>`;
        }

        function onIpStart(e) {
            dragTarget = e.currentTarget;
            const evt = e.type.includes('touch') ? e.touches[0] : e;
            startX = evt.clientX;
            startY = evt.clientY;
            initialX = dragTarget.offsetLeft;
            initialY = dragTarget.offsetTop;
            dragTarget.style.cursor = 'grabbing';
            e.stopPropagation();
            if (e.cancelable) e.preventDefault();
        }

        function onGlobalMouseMove(e) {
            if (!dragTarget || isMoving) return;
            isMoving = true;
            requestAnimationFrame(() => {
                const evt = e.type.includes('touch') ? e.touches[0] : e;
                const dx = (evt.clientX - startX) / state.previewScale;
                const dy = (evt.clientY - startY) / state.previewScale;
                dragTarget.style.left = (initialX + dx) + 'px';
                dragTarget.style.top = (initialY + dy) + 'px';
                dragTarget.style.right = 'auto';
                dragTarget.style.bottom = 'auto';
                isMoving = false;
            });
        }

        function onGlobalMouseUp() {
            if (!dragTarget) return;
            dragTarget.style.cursor = 'grab';
            dragTarget = null;
        }

        async function downloadAll() {
            const overlay = document.getElementById('export-overlay');
            const prog = document.getElementById('progress-val');
            overlay.style.display = 'flex';
            const zip = new JSZip();
            const cards = document.querySelectorAll('.card-container');
            
            for (let i = 0; i < cards.length; i++) {
                prog.innerText = `${i+1} / ${cards.length}`;
                const original = cards[i];
                const clone = original.cloneNode(true);
                
                // 強制規範克隆節點樣式
                clone.style.transform = 'none';
                clone.style.margin = '0';
                clone.style.position = 'fixed';
                clone.style.top = '0';
                clone.style.left = '-9999px';
                clone.style.width = '1080px';
                clone.style.height = '1350px';
                clone.style.boxSizing = 'border-box';
                
                // 根據款式設置正確的背景色
                let bgColor = '#ffffff';
                let textColor = '#000000';
                let accentColor = '#000000';
                
                switch(state.style) {
                    case 'dry':
                        bgColor = '#1e293b';
                        textColor = '#f8fafc';
                        accentColor = '#38bdf8';
                        break;
                    case 'poster':
                        bgColor = '#FFD700';
                        textColor = '#000000';
                        accentColor = '#000000';
                        break;
                    case 'memo':
                        bgColor = '#fff9c4';
                        textColor = '#4a4a4a';
                        accentColor = '#4a4a4a';
                        break;
                    case 'journal':
                        bgColor = '#FFF0F5';
                        textColor = '#5D4037';
                        accentColor = '#f9a8d4';
                        break;
                    case 'minimal':
                        bgColor = '#fdfdfd';
                        textColor = '#333333';
                        accentColor = state.theme;
                        break;
                }
                
                clone.style.backgroundColor = bgColor;
                document.body.appendChild(clone);

                const canvas = await html2canvas(clone, { 
                    scale: 2, // 提高DPI
                    width: 1080, 
                    height: 1350, 
                    useCORS: true, 
                    backgroundColor: bgColor,
                    imageTimeout: 0, 
                    logging: false,
                    allowTaint: true,
                    onclone: (clonedDoc, clonedElement) => {
                        // 確保整個卡片可見
                        const clonedCard = clonedElement.querySelector('.card-container');
                        if (clonedCard) {
                            clonedCard.style.setProperty('--theme', state.theme);
                            clonedCard.style.visibility = 'visible';
                            clonedCard.style.opacity = '1';
                            clonedCard.style.display = 'block';
                            
                            // 為大字報款式強制注入所有樣式
                            if (state.style === 'poster') {
                                // 修復大字報背景色
                                clonedCard.style.backgroundColor = '#FFD700';
                                
                                // 修復標題區塊
                                const bigTitles = clonedCard.querySelectorAll('.big-title');
                                bigTitles.forEach(el => {
                                    el.style.backgroundColor = '#ffffff';
                                    el.style.color = '#000000';
                                    el.style.border = '8px solid #000000';
                                    el.style.boxShadow = '15px 15px 0px #000000';
                                    el.style.fontWeight = '900';
                                    el.style.fontFamily = "'Noto Sans SC', sans-serif";
                                });
                                
                                // 修復內容區塊
                                const contentBoxes = clonedCard.querySelectorAll('.content-box');
                                contentBoxes.forEach(el => {
                                    el.style.backgroundColor = '#ffffff';
                                    el.style.color = '#000000';
                                    el.style.border = '4px solid #000000';
                                    el.style.boxShadow = '10px 10px 0px #000000';
                                    el.style.fontWeight = 'bold';
                                    el.style.fontFamily = "'Noto Sans SC', sans-serif";
                                });
                                
                                // 修復其他文本元素
                                clonedCard.querySelectorAll('h1, h2, h3, p, div, span').forEach(el => {
                                    if (!el.closest('.big-title') && !el.closest('.content-box')) {
                                        if (window.getComputedStyle(el).color === 'rgb(0, 0, 0)' || 
                                            el.textContent.trim().length > 0) {
                                            el.style.color = '#000000';
                                        }
                                    }
                                });
                            }
                            
                            // 確保所有文本可見
                            clonedCard.querySelectorAll('*').forEach(el => {
                                const computed = window.getComputedStyle(el);
                                if (computed.color === 'rgba(0, 0, 0, 0)' || 
                                    computed.color === 'transparent' ||
                                    computed.opacity === '0') {
                                    el.style.color = textColor;
                                    el.style.opacity = '1';
                                }
                            });
                        }
                    }
                });
                document.body.removeChild(clone);
                const blob = await new Promise(res => canvas.toBlob(res, 'image/png', 1.0));
                zip.file(`HD_Post_${i+1}.png`, blob);
            }
            
            const final = await zip.generateAsync({type: 'blob'});
            saveAs(final, `VisualClone_HD_Export_${Date.now()}.zip`);
            overlay.style.display = 'none';
        }

        window.onload = init;
    </script>
</body>
</html>
